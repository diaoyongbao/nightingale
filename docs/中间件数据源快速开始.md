# 中间件数据源快速开始指南

## 概述

本指南帮助您快速了解如何使用新的中间件数据源系统。

## 核心概念

### 什么是中间件数据源?

中间件数据源是一个统一的配置管理系统,用于管理各种运维中间件(如 Archery、JumpServer、Jenkins 等)的连接配置。

### 为什么需要中间件数据源?

**原有方式的问题:**
- Archery 配置硬编码在 `config.toml` 文件中
- 修改配置需要重启服务
- 不支持配置多个实例
- 配置分散,难以管理

**新方式的优势:**
- ✅ 配置存储在数据库中
- ✅ 支持动态增删改查
- ✅ 支持配置多个中间件实例
- ✅ 统一的管理界面
- ✅ 支持敏感信息加密
- ✅ 内置健康检查

## 已创建的文件

### 1. 数据库模型
```
nightingale/models/
├── middleware_datasource.go          # 核心模型定义
└── middleware_datasource_migrate.go  # 迁移辅助函数
```

### 2. 数据库迁移
```
nightingale/models/migrate/
└── migrate_middleware_datasource.go  # 数据库迁移脚本
```

### 3. 设计文档
```
nightingale/docs/
├── 中间件数据源设计.md      # 详细设计文档
└── 中间件数据源实施总结.md  # 实施总结
```

## 数据库表结构

### middleware_datasource 表

| 字段 | 类型 | 说明 |
|------|------|------|
| id | bigint | 主键 |
| name | varchar(191) | 数据源名称 (唯一) |
| type | varchar(64) | 中间件类型 (archery, jumpserver, jenkins 等) |
| description | varchar(500) | 描述 |
| address | varchar(500) | 中间件地址 |
| status | varchar(32) | 状态 (enabled/disabled) |
| timeout | int | 请求超时 (毫秒) |
| connect_timeout | int | 连接超时 (毫秒) |
| insecure_skip_verify | tinyint | 是否跳过 SSL 验证 |
| auth_type | varchar(32) | 认证类型 (token/basic/session/oauth2/none) |
| auth_config | text | 认证配置 JSON |
| auth_config_encoded | text | 加密后的认证配置 |
| settings | text | 扩展配置 JSON |
| settings_encoded | text | 加密后的扩展配置 |
| health_check_url | varchar(500) | 健康检查 URL |
| health_check_interval | int | 健康检查间隔 (秒) |
| last_health_check | bigint | 最后健康检查时间 |
| health_status | varchar(32) | 健康状态 (healthy/unhealthy/unknown) |
| health_message | varchar(500) | 健康检查消息 |
| tags | varchar(500) | 标签 |
| order_num | int | 排序号 |
| created_at | bigint | 创建时间 |
| created_by | varchar(64) | 创建人 |
| updated_at | bigint | 更新时间 |
| updated_by | varchar(64) | 更新人 |

## 支持的中间件类型

### 已预定义的类型

```go
const (
    MiddlewareTypeArchery    = "archery"      // SQL 审核平台
    MiddlewareTypeJumpServer = "jumpserver"   // 堡垒机
    MiddlewareTypeJenkins    = "jenkins"      // CI/CD
    MiddlewareTypeGitLab     = "gitlab"       // 代码仓库
    MiddlewareTypeNacos      = "nacos"        // 配置中心
    MiddlewareTypeConsul     = "consul"       // 服务发现
)
```

### 支持的认证方式

```go
const (
    AuthTypeToken   = "token"    // Bearer Token / API Token
    AuthTypeBasic   = "basic"    // HTTP Basic Auth
    AuthTypeSession = "session"  // Session Cookie
    AuthTypeOAuth2  = "oauth2"   // OAuth2
    AuthTypeNone    = "none"     // 无需认证
)
```

## 使用示例

### 示例 1: 创建 Archery 数据源 (Token 认证)

```go
package main

import (
    "time"
    "github.com/ccfos/nightingale/v6/models"
    "github.com/ccfos/nightingale/v6/pkg/ctx"
)

func createArcheryWithToken(c *ctx.Context) error {
    ds := &models.MiddlewareDatasource{
        Name:        "archery-prod",
        Type:        models.MiddlewareTypeArchery,
        Description: "生产环境 Archery SQL 审核平台",
        Address:     "https://archery.example.com",
        Status:      models.MiddlewareStatusEnabled,
        
        // 连接配置
        Timeout:            5000,
        ConnectTimeout:     2000,
        InsecureSkipVerify: false,
        
        // Token 认证
        AuthType: models.AuthTypeToken,
        AuthConfigJson: map[string]interface{}{
            "token":         "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
            "header_name":   "Authorization",
            "header_prefix": "Bearer",
        },
        
        // 扩展配置
        SettingsJson: map[string]interface{}{
            "api_version": "v1",
            "features": map[string]bool{
                "sql_query":  true,
                "sql_check":  true,
                "slow_query": true,
            },
        },
        
        // 健康检查
        HealthCheckUrl:      "/api/health/",
        HealthCheckInterval: 60,
        
        // 审计信息
        CreatedAt: time.Now().Unix(),
        CreatedBy: "admin",
        UpdatedAt: time.Now().Unix(),
        UpdatedBy: "admin",
    }
    
    return ds.Add(c)
}
```

### 示例 2: 创建 JumpServer 数据源 (Basic Auth)

```go
func createJumpServer(c *ctx.Context) error {
    ds := &models.MiddlewareDatasource{
        Name:        "jumpserver-prod",
        Type:        models.MiddlewareTypeJumpServer,
        Description: "生产环境堡垒机",
        Address:     "https://jumpserver.example.com",
        Status:      models.MiddlewareStatusEnabled,
        
        Timeout:        5000,
        ConnectTimeout: 2000,
        
        // Basic Auth 认证
        AuthType: models.AuthTypeBasic,
        AuthConfigJson: map[string]interface{}{
            "username": "admin",
            "password": "your-password",
        },
        
        SettingsJson: map[string]interface{}{
            "api_version":    "v2",
            "asset_group_id": "default",
            "protocol":       "ssh",
            "port":           22,
        },
        
        HealthCheckUrl:      "/api/health/",
        HealthCheckInterval: 60,
        
        CreatedAt: time.Now().Unix(),
        CreatedBy: "admin",
        UpdatedAt: time.Now().Unix(),
        UpdatedBy: "admin",
    }
    
    return ds.Add(c)
}
```

### 示例 3: 查询所有启用的 Archery 实例

```go
func listArcheryInstances(c *ctx.Context) ([]*models.MiddlewareDatasource, error) {
    return models.GetEnabledMiddlewareDatasourcesByType(c, models.MiddlewareTypeArchery)
}
```

### 示例 4: 更新健康状态

```go
func updateHealth(c *ctx.Context, id int64) error {
    ds, err := models.MiddlewareDatasourceGet(c, id)
    if err != nil {
        return err
    }
    
    return ds.UpdateHealthStatus(c, models.HealthStatusHealthy, "服务正常")
}
```

### 示例 5: 从配置文件迁移 Archery

```go
import (
    "github.com/ccfos/nightingale/v6/models"
    "github.com/ccfos/nightingale/v6/center/dbm"
)

func migrateFromConfig(c *ctx.Context, config *ConfigType) error {
    // 假设从配置文件读取
    archeryConf := config.Integrations.Archery
    
    // 自动迁移到数据库
    return models.MigrateArcheryConfigToDB(c, archeryConf)
}
```

## 认证配置详解

### 1. Token 认证

适用于: Archery、JumpServer (使用 API Token)

```json
{
  "token": "your-api-token-here",
  "header_name": "Authorization",
  "header_prefix": "Bearer"
}
```

### 2. Basic Auth 认证

适用于: Jenkins、部分 REST API

```json
{
  "username": "admin",
  "password": "your-password"
}
```

### 3. Session 认证

适用于: 需要先登录获取 Session 的系统

```json
{
  "username": "admin",
  "password": "your-password",
  "login_url": "/api/login",
  "cookie_name": "sessionid"
}
```

### 4. OAuth2 认证

适用于: 支持 OAuth2 的系统

```json
{
  "client_id": "your-client-id",
  "client_secret": "your-client-secret",
  "token_url": "https://auth.example.com/oauth/token",
  "scopes": ["read", "write"]
}
```

## API 方法参考

### 基础 CRUD

```go
// 添加
ds.Add(ctx)

// 更新 (更新所有字段)
ds.Update(ctx, "*")

// 更新指定字段
ds.Update(ctx, "status", "health_status")

// 删除
models.MiddlewareDatasourceDel(ctx, []int64{id1, id2})

// 根据 ID 获取
ds, err := models.MiddlewareDatasourceGet(ctx, id)

// 根据名称获取
ds, err := models.MiddlewareDatasourceGetByName(ctx, "archery-prod")
```

### 查询方法

```go
// 获取所有
list, err := models.GetMiddlewareDatasources(ctx)

// 根据类型获取
list, err := models.GetMiddlewareDatasourcesByType(ctx, models.MiddlewareTypeArchery)

// 获取启用的
list, err := models.GetEnabledMiddlewareDatasourcesByType(ctx, models.MiddlewareTypeArchery)

// 复杂查询 (支持分页)
list, err := models.GetMiddlewareDatasourcesBy(
    ctx,
    "archery",           // type
    "enabled",           // status
    "prod",              // keyword
    10,                  // limit
    0,                   // offset
)

// 获取数量
count, err := models.GetMiddlewareDatasourcesCount(ctx, "archery", "enabled", "prod")
```

### 辅助方法

```go
// 检查是否存在
exists, err := models.MiddlewareDatasourceExists(ctx, "archery-prod")

// 验证认证配置
err := ds.ValidateAuthConfig()

// 检查状态
if ds.IsEnabled() {
    // ...
}

if ds.IsHealthy() {
    // ...
}

// 获取认证配置值
token := ds.GetAuthConfigString("token")
username := ds.GetAuthConfigString("username")

// 获取扩展配置值
apiVersion := ds.GetSettingsString("api_version")
enabled := ds.GetSettingsBool("some_feature")
```

## 数据加密

### 加密敏感信息

```go
// 获取 RSA 公钥
rsaConfig := models.GetRsaConfig()
if rsaConfig == nil || !rsaConfig.OpenRSA {
    // RSA 未启用
    return
}

// 加密
err := ds.Encrypt(rsaConfig.OpenRSA, []byte(rsaConfig.RSAPublicKey))
if err != nil {
    return err
}

// 此时 ds.AuthConfigEncoded 和 ds.SettingsEncoded 包含加密数据
// ds.AuthConfig 和 ds.Settings 已被清空
```

### 解密敏感信息

```go
rsaConfig := models.GetRsaConfig()

err := ds.Decrypt(rsaConfig.PrivateKeyBytes, rsaConfig.RSAPassWord)
if err != nil {
    return err
}

// 此时 ds.AuthConfigJson 和 ds.SettingsJson 包含解密后的数据
```

## 下一步

### 待完成的工作

1. **集成到数据库迁移** - 修改 `models/migrate/migrate.go`
2. **实现 API 接口** - 创建 `center/router/router_middleware.go`
3. **实现前端管理界面** - 创建 `fe/src/pages/middleware/`
4. **重构 Archery 客户端** - 修改从数据库读取配置
5. **实现健康检查定时任务** - 定期检查中间件健康状态

### 参考文档

- 详细设计: `nightingale/docs/中间件数据源设计.md`
- 实施总结: `nightingale/docs/中间件数据源实施总结.md`
- 集成说明: `nightingale/docs/DBM集成说明.md`

## 常见问题

### Q: 如何从配置文件迁移到数据库?

A: 调用 `models.MigrateArcheryConfigToDB(ctx, archeryConfig)`,它会自动检查数据库中是否已存在配置,避免重复迁移。

### Q: 是否支持多个 Archery 实例?

A: 是的,可以配置多个 Archery 实例,每个实例有唯一的 `name` 标识。

### Q: 敏感信息如何保护?

A: 使用 RSA 加密存储在 `auth_config_encoded` 和 `settings_encoded` 字段中,读取时自动解密。

### Q: 如何扩展支持新的中间件类型?

A: 只需在创建数据源时指定新的 `type` 值即可,模型已支持任意类型扩展。

## 贡献指南

如有问题或建议,请:
1. 查看现有文档
2. 检查代码注释
3. 提交 Issue 或 Pull Request

---

**版本:** 1.0.0  
**最后更新:** 2025-01-06
