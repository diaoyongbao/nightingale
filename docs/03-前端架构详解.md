# 夜莺监控前端架构详解

## 1. 整体架构

### 1.1 技术选型

```
React 17.0.0 (UI框架)
    │
    ├─► React Router DOM 5.2.0 (路由)
    ├─► Ant Design 4.21.0 (UI组件)
    ├─► React Hooks Global State (状态管理)
    ├─► umi-request (HTTP客户端)
    ├─► i18next (国际化)
    └─► Vite 4.5.14 (构建工具)
```

### 1.2 目录结构

```
src/
├── App.tsx                 # 应用入口
├── main.tsx               # React渲染入口
├── pages/                 # 页面组件
│   ├── alertRules/        # 告警规则管理
│   ├── alertCurEvent/     # 当前告警事件
│   ├── historyEvents/     # 历史告警事件
│   ├── dashboard/         # 仪表盘
│   ├── explorer/          # 数据探索
│   ├── targets/           # 监控对象
│   ├── user/              # 用户管理
│   ├── datasource/        # 数据源管理
│   ├── warning/           # 告警屏蔽/订阅
│   ├── login/             # 登录
│   ├── event/             # 事件详情
│   ├── notificationChannels/  # 通知渠道
│   ├── notificationRules/     # 通知规则
│   ├── notificationTemplates/ # 通知模板
│   ├── eventPipeline/     # 事件管道
│   └── ...
├── components/            # 公共组件
│   ├── AdvancedWrap/      # 高级功能包装
│   ├── BusinessGroup/     # 业务组选择器
│   ├── TimeRangePicker/   # 时间范围选择器
│   ├── Feedback/          # 反馈组件
│   ├── SideMenu/          # 侧边菜单
│   └── ...
├── services/              # API服务
│   ├── account.ts         # 账户相关
│   ├── common.ts          # 公共接口
│   ├── warning.ts         # 告警相关
│   ├── manage.ts          # 管理相关
│   ├── dashboardV2.ts     # 仪表盘
│   └── ...
├── routers/               # 路由配置
│   └── index.tsx          # 路由定义
├── store/                 # 全局状态
│   ├── commonInterface.ts # 公共接口定义
│   └── ...
├── utils/                 # 工具函数
│   ├── request.ts         # HTTP请求封装
│   ├── constant.ts        # 常量定义
│   ├── darkMode.ts        # 暗黑模式
│   └── ...
├── locales/               # 国际化文件
│   ├── zh_CN/             # 中文
│   ├── en_US/             # 英文
│   └── zh_HK/             # 繁体中文
├── plugins/               # 插件系统
├── theme/                 # 主题配置
└── types/                 # TypeScript类型定义
```

## 2. 核心模块

### 2.1 应用入口 (App.tsx)

**职责**: 应用初始化、全局状态管理、路由配置

**核心功能**:

1. **全局状态初始化**
   ```typescript
   interface ICommonState {
       datasourceCateOptions: Cate[];
       groupedDatasourceList: { [index: string]: Datasource[] };
       datasourceList: Datasource[];
       busiGroups: { name: string; id: number }[];
       curBusiId: number;
       businessGroup: { key?: string; ids?: string; id?: number };
       profile: IProfile;
       versions: { version: string; github_verison: string };
       siteInfo?: { [index: string]: string };
       darkMode: boolean;
       perms?: string[];
       // ... 更多状态
   }
   ```

2. **数据初始化流程**
   ```typescript
   useEffect(() => {
       // 1. 获取站点信息
       const siteInfo = await getN9eConfig('site_info');
       
       // 2. 获取用户信息
       const { dat: profile } = await GetProfile();
       
       // 3. 获取业务组列表
       const { dat: busiGroups } = await getBusiGroups();
       
       // 4. 获取权限列表
       const { dat: perms } = await getMenuPerm();
       
       // 5. 获取数据源列表
       const datasourceList = await getDatasourceBriefList();
       
       // 6. 获取许可证信息
       const { licenseRulesRemaining, licenseExpireDays, feats } = await getLicense(t);
       
       // 7. 更新全局状态
       setCommonState({ ... });
   }, []);
   ```

3. **Context Provider**
   ```typescript
   <CommonStateContext.Provider value={commonState}>
       <ConfigProvider locale={i18n.language == 'en_US' ? enUS : zhCN}>
           <Router basename={basePrefix}>
               <Switch>
                   <Route path='/job-task/:busiId/output/:taskId/:outputType' component={TaskOutput} />
                   <>
                       <HeaderMenu />
                       <Content />
                   </>
               </Switch>
           </Router>
       </ConfigProvider>
   </CommonStateContext.Provider>
   ```

### 2.2 路由系统 (routers/index.tsx)

**路由配置**:

```typescript
// 核心路由
<Switch>
    {/* 登录相关 */}
    <Route path='/login' component={Login} exact />
    <Route path='/callback' component={LoginCallback} exact />
    
    {/* 数据探索 */}
    <Route path='/metric/explorer' component={MetricExplore} exact />
    <Route path='/log/explorer' component={LogExplore} exact />
    <Route path='/trace/explorer' component={TraceExplorer} exact />
    
    {/* 告警管理 */}
    <Route path='/alert-rules' component={AlertRules} exact />
    <Route path='/alert-rules/add/:bgid' component={AlertRuleAdd} exact />
    <Route path='/alert-rules/edit/:id' component={AlertRuleEdit} exact />
    <Route path='/alert-mutes' component={Shield} exact />
    <Route path='/alert-subscribes' component={Subscribe} exact />
    <Route path='/alert-cur-events/:eventId' component={EventDetail} exact />
    <Route path='/alert-his-events' component={historyEvents} exact />
    
    {/* 仪表盘 */}
    <Route path='/dashboards' component={Dashboard} />
    <Route path='/dashboards/:id' component={DashboardDetail} exact />
    
    {/* 监控对象 */}
    <Route path='/targets' component={Targets} exact />
    
    {/* 用户管理 */}
    <Route path='/users' component={Users} />
    <Route path='/user-groups' component={Groups} />
    <Route path='/busi-groups' component={Business} />
    
    {/* 数据源管理 */}
    <Route path='/datasources' component={Datasource} exact />
    
    {/* 通知管理 */}
    <Route path='/notification-channels' component={NotificationChannels} />
    <Route path='/notification-rules' component={NotificationRules} />
    <Route path='/notification-templates' component={NotificationTemplates} />
    
    {/* 事件管道 */}
    <Route path='/event-pipelines' component={EventPipeline} />
    
    {/* 默认路由 */}
    <Route path='/' exact>
        <Redirect to={siteInfo?.home_page_url || '/metric/explorer'} />
    </Route>
    
    {/* 404 */}
    <Route path='*' component={NotFound} />
</Switch>
```

**权限控制**:

```typescript
useEffect(() => {
    // 检查用户权限
    if (profile?.roles?.length > 0 && profile?.roles.indexOf('Admin') === -1) {
        // 如果没有权限则重定向到 403 页面
        if (_.every(perms, (item) => location.pathname.indexOf(item) === -1)) {
            history.push('/403');
        }
    }
}, []);
```

### 2.3 服务层 (services/)

**API服务封装**:

1. **请求封装** (utils/request.ts)
   ```typescript
   import request from 'umi-request';
   
   // 请求拦截器
   request.interceptors.request.use((url, options) => {
       // 添加认证头
       const token = localStorage.getItem('access_token');
       if (token) {
           options.headers = {
               ...options.headers,
               Authorization: `Bearer ${token}`,
           };
       }
       return { url, options };
   });
   
   // 响应拦截器
   request.interceptors.response.use((response) => {
       // 统一错误处理
       if (response.status === 401) {
           // 跳转到登录页
           window.location.href = '/login';
       }
       return response;
   });
   ```

2. **API服务** (services/warning.ts)
   ```typescript
   // 获取告警规则列表
   export function getAlertRules(busiGroupId: number) {
       return request(`/api/n9e/busi-group/${busiGroupId}/alert-rules`, {
           method: 'GET',
       });
   }
   
   // 创建告警规则
   export function createAlertRule(busiGroupId: number, data: any) {
       return request(`/api/n9e/busi-group/${busiGroupId}/alert-rules`, {
           method: 'POST',
           body: JSON.stringify(data),
       });
   }
   
   // 更新告警规则
   export function updateAlertRule(busiGroupId: number, ruleId: number, data: any) {
       return request(`/api/n9e/busi-group/${busiGroupId}/alert-rule/${ruleId}`, {
           method: 'PUT',
           body: JSON.stringify(data),
       });
   }
   
   // 删除告警规则
   export function deleteAlertRules(busiGroupId: number, ids: number[]) {
       return request(`/api/n9e/busi-group/${busiGroupId}/alert-rules`, {
           method: 'DELETE',
           body: JSON.stringify({ ids }),
       });
   }
   ```

### 2.4 公共组件

#### 2.4.1 业务组选择器 (components/BusinessGroup/)

```typescript
interface BusinessGroupProps {
    value?: string;
    onChange?: (value: string) => void;
    showAll?: boolean;
}

const BusinessGroup: React.FC<BusinessGroupProps> = ({ value, onChange, showAll }) => {
    const { busiGroups } = useContext(CommonStateContext);
    
    return (
        <TreeSelect
            treeData={buildTreeData(busiGroups)}
            value={value}
            onChange={onChange}
            placeholder="请选择业务组"
        />
    );
};
```

#### 2.4.2 时间范围选择器 (components/TimeRangePicker/)

```typescript
interface TimeRangePickerProps {
    value?: IRawTimeRange;
    onChange?: (value: IRawTimeRange) => void;
}

const TimeRangePicker: React.FC<TimeRangePickerProps> = ({ value, onChange }) => {
    return (
        <div>
            {/* 快捷选项 */}
            <Radio.Group>
                <Radio.Button value="now-1h">最近1小时</Radio.Button>
                <Radio.Button value="now-6h">最近6小时</Radio.Button>
                <Radio.Button value="now-24h">最近24小时</Radio.Button>
                <Radio.Button value="now-7d">最近7天</Radio.Button>
            </Radio.Group>
            
            {/* 自定义时间 */}
            <DatePicker.RangePicker />
        </div>
    );
};
```

#### 2.4.3 侧边菜单 (components/SideMenu/)

```typescript
const SideMenu: React.FC = () => {
    const { profile, perms, sideMenuBgMode } = useContext(CommonStateContext);
    
    const menuItems = [
        {
            key: '/metric/explorer',
            icon: <LineChartOutlined />,
            label: '指标查询',
        },
        {
            key: '/log/explorer',
            icon: <FileTextOutlined />,
            label: '日志查询',
        },
        {
            key: '/alert-rules',
            icon: <AlertOutlined />,
            label: '告警规则',
            children: [
                { key: '/alert-rules', label: '告警规则' },
                { key: '/alert-mutes', label: '告警屏蔽' },
                { key: '/alert-subscribes', label: '告警订阅' },
            ],
        },
        // ... 更多菜单项
    ];
    
    // 根据权限过滤菜单
    const filteredMenuItems = filterMenuByPerms(menuItems, perms);
    
    return (
        <Menu
            mode="inline"
            items={filteredMenuItems}
            selectedKeys={[location.pathname]}
        />
    );
};
```

## 3. 核心页面

### 3.1 告警规则管理 (pages/alertRules/)

**页面结构**:

```
alertRules/
├── index.tsx              # 列表页
├── Form.tsx              # 表单组件
├── Add.tsx               # 新建页面
├── Edit.tsx              # 编辑页面
├── components/           # 子组件
│   ├── RuleType.tsx      # 规则类型选择
│   ├── PromQLInput.tsx   # PromQL输入
│   ├── Triggers.tsx      # 触发条件
│   ├── NotifyConfig.tsx  # 通知配置
│   └── ...
└── locale/               # 国际化
```

**核心功能**:

1. **规则列表**
   ```typescript
   const AlertRules: React.FC = () => {
       const [rules, setRules] = useState([]);
       const [loading, setLoading] = useState(false);
       const { curBusiId } = useContext(CommonStateContext);
       
       useEffect(() => {
           fetchRules();
       }, [curBusiId]);
       
       const fetchRules = async () => {
           setLoading(true);
           const res = await getAlertRules(curBusiId);
           setRules(res.dat || []);
           setLoading(false);
       };
       
       return (
           <Table
               dataSource={rules}
               loading={loading}
               columns={[
                   { title: '规则名称', dataIndex: 'name' },
                   { title: '告警级别', dataIndex: 'severity' },
                   { title: '状态', dataIndex: 'disabled' },
                   { title: '操作', render: (_, record) => (
                       <>
                           <a onClick={() => handleEdit(record)}>编辑</a>
                           <a onClick={() => handleDelete(record)}>删除</a>
                       </>
                   )},
               ]}
           />
       );
   };
   ```

2. **规则表单**
   ```typescript
   const RuleForm: React.FC = () => {
       const [form] = Form.useForm();
       
       return (
           <Form form={form} onFinish={handleSubmit}>
               {/* 基本信息 */}
               <Form.Item name="name" label="规则名称" rules={[{ required: true }]}>
                   <Input />
               </Form.Item>
               
               {/* 规则类型 */}
               <Form.Item name="cate" label="规则类型">
                   <Select>
                       <Option value="prometheus">Prometheus</Option>
                       <Option value="elasticsearch">Elasticsearch</Option>
                       <Option value="loki">Loki</Option>
                   </Select>
               </Form.Item>
               
               {/* 数据源 */}
               <Form.Item name="datasource_ids" label="数据源">
                   <DatasourceSelect />
               </Form.Item>
               
               {/* PromQL */}
               <Form.Item name="prom_ql" label="查询语句">
                   <PromQLInput />
               </Form.Item>
               
               {/* 触发条件 */}
               <Form.Item name="triggers" label="触发条件">
                   <Triggers />
               </Form.Item>
               
               {/* 通知配置 */}
               <Form.Item name="notify_rule_ids" label="通知规则">
                   <NotifyRuleSelect />
               </Form.Item>
           </Form>
       );
   };
   ```

### 3.2 仪表盘 (pages/dashboard/)

**页面结构**:

```
dashboard/
├── List/                 # 列表页
├── Detail/               # 详情页
│   ├── index.tsx
│   ├── VariableConfig/   # 变量配置
│   ├── Panels/           # 图表面板
│   │   ├── Timeseries/   # 时序图
│   │   ├── Stat/         # 统计图
│   │   ├── Table/        # 表格
│   │   ├── Pie/          # 饼图
│   │   └── ...
│   └── utils.ts
└── Share/                # 分享页面
```

**核心功能**:

1. **仪表盘编辑器**
   ```typescript
   const DashboardDetail: React.FC = () => {
       const [dashboard, setDashboard] = useState<Dashboard>();
       const [panels, setPanels] = useState<Panel[]>([]);
       const [variables, setVariables] = useState<Variable[]>([]);
       
       return (
           <div className="dashboard-detail">
               {/* 工具栏 */}
               <Toolbar
                   onSave={handleSave}
                   onAddPanel={handleAddPanel}
                   onSettings={handleSettings}
               />
               
               {/* 变量配置 */}
               <VariableConfig
                   variables={variables}
                   onChange={setVariables}
               />
               
               {/* 图表网格 */}
               <GridLayout
                   layout={panels}
                   onLayoutChange={handleLayoutChange}
               >
                   {panels.map(panel => (
                       <Panel
                           key={panel.id}
                           config={panel}
                           variables={variables}
                       />
                   ))}
               </GridLayout>
           </div>
       );
   };
   ```

2. **图表组件**
   ```typescript
   const Panel: React.FC<PanelProps> = ({ config, variables }) => {
       const [data, setData] = useState([]);
       const [loading, setLoading] = useState(false);
       
       useEffect(() => {
           fetchData();
       }, [config, variables]);
       
       const fetchData = async () => {
           setLoading(true);
           const res = await queryData({
               queries: config.targets,
               range: config.timeRange,
           });
           setData(res.dat || []);
           setLoading(false);
       };
       
       return (
           <div className="panel">
               <div className="panel-header">{config.title}</div>
               <div className="panel-body">
                   {loading ? <Spin /> : renderChart(config.type, data)}
               </div>
           </div>
       );
   };
   ```

### 3.3 数据探索 (pages/explorer/)

**页面结构**:

```
explorer/
├── Metric/               # 指标查询
│   ├── index.tsx
│   ├── QueryBuilder/     # 查询构建器
│   ├── Graph/            # 图表展示
│   └── Table/            # 表格展示
├── Log/                  # 日志查询
│   ├── index.tsx
│   ├── QueryEditor/      # 查询编辑器
│   ├── LogList/          # 日志列表
│   └── LogDetail/        # 日志详情
└── Object/               # 对象查询
```

**核心功能**:

1. **指标查询**
   ```typescript
   const MetricExplorer: React.FC = () => {
       const [queries, setQueries] = useState<Query[]>([]);
       const [timeRange, setTimeRange] = useState<TimeRange>();
       const [data, setData] = useState([]);
       
       const handleQuery = async () => {
           const res = await queryMetrics({
               queries,
               start: timeRange.start,
               end: timeRange.end,
           });
           setData(res.dat || []);
       };
       
       return (
           <div className="metric-explorer">
               {/* 查询构建器 */}
               <QueryBuilder
                   queries={queries}
                   onChange={setQueries}
               />
               
               {/* 时间范围 */}
               <TimeRangePicker
                   value={timeRange}
                   onChange={setTimeRange}
               />
               
               {/* 查询按钮 */}
               <Button onClick={handleQuery}>查询</Button>
               
               {/* 图表展示 */}
               <Graph data={data} />
               
               {/* 表格展示 */}
               <Table dataSource={data} />
           </div>
       );
   };
   ```

2. **日志查询**
   ```typescript
   const LogExplorer: React.FC = () => {
       const [query, setQuery] = useState('');
       const [logs, setLogs] = useState([]);
       const [timeRange, setTimeRange] = useState<TimeRange>();
       
       const handleQuery = async () => {
           const res = await queryLogs({
               query,
               start: timeRange.start,
               end: timeRange.end,
           });
           setLogs(res.dat || []);
       };
       
       return (
           <div className="log-explorer">
               {/* 查询编辑器 */}
               <QueryEditor
                   value={query}
                   onChange={setQuery}
               />
               
               {/* 时间范围 */}
               <TimeRangePicker
                   value={timeRange}
                   onChange={setTimeRange}
               />
               
               {/* 查询按钮 */}
               <Button onClick={handleQuery}>查询</Button>
               
               {/* 日志列表 */}
               <LogList logs={logs} />
           </div>
       );
   };
   ```

## 4. 状态管理

### 4.1 全局状态 (CommonStateContext)

```typescript
export const CommonStateContext = createContext({} as ICommonState);

// 在App.tsx中提供
<CommonStateContext.Provider value={commonState}>
    {children}
</CommonStateContext.Provider>

// 在组件中使用
const { profile, busiGroups, datasourceList } = useContext(CommonStateContext);
```

### 4.2 本地状态 (useState/useReducer)

```typescript
// 简单状态
const [loading, setLoading] = useState(false);

// 复杂状态
const [state, dispatch] = useReducer(reducer, initialState);
```

### 4.3 URL状态 (useHistory/useLocation)

```typescript
const history = useHistory();
const location = useLocation();
const query = querystring.parse(location.search);

// 更新URL参数
history.push({
    pathname: location.pathname,
    search: querystring.stringify({ ...query, page: 2 }),
});
```

## 5. 国际化

### 5.1 配置 (i18n.ts)

```typescript
import i18n from 'i18next';
import { initReactI18next } from 'react-i18next';

i18n
    .use(initReactI18next)
    .init({
        resources: {
            zh_CN: {
                common: require('./locales/zh_CN/common.json'),
                dashboard: require('./locales/zh_CN/dashboard.json'),
            },
            en_US: {
                common: require('./locales/en_US/common.json'),
                dashboard: require('./locales/en_US/dashboard.json'),
            },
        },
        lng: 'zh_CN',
        fallbackLng: 'zh_CN',
        interpolation: {
            escapeValue: false,
        },
    });
```

### 5.2 使用

```typescript
import { useTranslation } from 'react-i18next';

const Component: React.FC = () => {
    const { t } = useTranslation();
    
    return <div>{t('common:welcome')}</div>;
};
```

## 6. 主题系统

### 6.1 暗黑模式

```typescript
// 获取暗黑模式状态
const { darkMode, setDarkMode } = useContext(CommonStateContext);

// 切换暗黑模式
const toggleDarkMode = () => {
    setDarkMode(!darkMode);
};

// 应用暗黑模式
useEffect(() => {
    document.body.className = darkMode ? 'theme-dark' : 'theme-light';
}, [darkMode]);
```

### 6.2 主题变量

```less
// global.variable.less
@primary-color: #1890ff;
@success-color: #52c41a;
@warning-color: #faad14;
@error-color: #f5222d;

// 暗黑模式变量
.theme-dark {
    --bg-color: #141414;
    --text-color: #fff;
    --border-color: #434343;
}
```

## 7. 性能优化

### 7.1 代码分割

```typescript
// 路由级别代码分割
const Dashboard = lazy(() => import('@/pages/dashboard'));

<Suspense fallback={<Spin />}>
    <Route path="/dashboards" component={Dashboard} />
</Suspense>
```

### 7.2 组件优化

```typescript
// 使用React.memo避免不必要的重渲染
const Panel = React.memo<PanelProps>(({ config, data }) => {
    return <div>{/* ... */}</div>;
}, (prevProps, nextProps) => {
    return _.isEqual(prevProps.config, nextProps.config) &&
           _.isEqual(prevProps.data, nextProps.data);
});

// 使用useMemo缓存计算结果
const filteredData = useMemo(() => {
    return data.filter(item => item.value > 0);
}, [data]);

// 使用useCallback缓存回调函数
const handleClick = useCallback(() => {
    console.log('clicked');
}, []);
```

### 7.3 虚拟列表

```typescript
import { FixedSizeList } from 'react-window';

const VirtualList: React.FC = ({ items }) => {
    return (
        <FixedSizeList
            height={600}
            itemCount={items.length}
            itemSize={50}
            width="100%"
        >
            {({ index, style }) => (
                <div style={style}>{items[index]}</div>
            )}
        </FixedSizeList>
    );
};
```

## 8. 构建和部署

### 8.1 开发环境

```bash
# 启动开发服务器
npm run dev

# 访问 http://localhost:8765
```

### 8.2 生产构建

```bash
# 构建
npm run build

# 输出目录: dist/
```

### 8.3 环境变量

```typescript
// .env
VITE_PREFIX=/flashcat
VITE_IS_ENT=false
VITE_IS_PRO=true

// 使用
const prefix = import.meta.env.VITE_PREFIX;
```

## 9. 插件系统

### 9.1 插件结构

```
plugins/
├── example-plugin/
│   ├── index.ts          # 插件入口
│   ├── routes.tsx        # 路由配置
│   ├── pages/            # 页面组件
│   └── package.json
```

### 9.2 插件注册

```typescript
// plugins/example-plugin/index.ts
export default {
    name: 'example-plugin',
    routes: [
        {
            path: '/example',
            component: () => import('./pages/Example'),
        },
    ],
};

// 动态加载插件
const plugins = dynamicPackages();
const routes = plugins.reduce((acc, plugin) => {
    return [...acc, ...plugin.routes];
}, []);
```

## 10. 测试

### 10.1 单元测试

```typescript
import { render, screen } from '@testing-library/react';
import Component from './Component';

test('renders component', () => {
    render(<Component />);
    const element = screen.getByText(/hello/i);
    expect(element).toBeInTheDocument();
});
```

### 10.2 集成测试

```typescript
import { renderHook } from '@testing-library/react-hooks';
import useCustomHook from './useCustomHook';

test('custom hook works', () => {
    const { result } = renderHook(() => useCustomHook());
    expect(result.current.value).toBe(0);
});
```

## 11. 最佳实践

### 11.1 组件设计

- 单一职责原则
- 组件复用
- Props类型定义
- 默认Props

### 11.2 状态管理

- 最小化状态
- 状态提升
- 避免过度渲染

### 11.3 代码规范

- TypeScript类型定义
- ESLint规则
- Prettier格式化
- 命名规范

### 11.4 性能优化

- 懒加载
- 代码分割
- 缓存优化
- 虚拟列表
