# AI助手 - 多步骤工具编排设计

> **文档目的**: 解决复杂任务需要调用多个 API、使用前一步返回数据作为后续步骤输入的场景。

---

## 1. 问题场景

### 1.1 典型多步骤任务示例

**场景 1: 为某业务组的所有主机创建告警屏蔽**
```
用户: "帮我屏蔽生产业务组下所有主机的告警 2 小时"

需要的步骤:
1. 查询 "生产业务组" 的 ID → GET /api/n9e/busi-groups?query=生产
2. 查询该业务组下的所有主机 → GET /api/n9e/targets?group_ids=1
3. 为这些主机创建屏蔽规则 → POST /api/n9e/busi-group/1/alert-mutes
```

**场景 2: 查询慢查询并 Kill 对应会话**
```
用户: "找出运行超过 1 小时的 SQL 并终止它"

需要的步骤:
1. 查询慢查询列表 → POST /api/n9e/dbm/slow-queries
2. 筛选运行时间 > 1 小时的会话
3. 终止这些会话 → POST /api/n9e/dbm/sessions/kill
```

**场景 3: 复制告警规则到另一个业务组**
```
用户: "把 ID 为 123 的告警规则复制到测试业务组"

需要的步骤:
1. 获取原规则详情 → GET /api/n9e/alert-rule/123
2. 查询目标业务组 ID → GET /api/n9e/busi-groups?query=测试
3. 在目标业务组创建规则 → POST /api/n9e/busi-group/{id}/alert-rules
```

### 1.2 核心挑战

| 挑战 | 说明 |
|------|------|
| **数据依赖** | 后续步骤需要前一步的返回数据 |
| **条件分支** | 根据中间结果决定下一步操作 |
| **错误处理** | 某一步失败时的回滚或补偿 |
| **并行执行** | 无依赖的步骤可以并行执行 |
| **用户确认** | 高风险操作前需要人工确认 |

---

## 2. 设计方案

### 2.1 方案对比

| 方案 | 优点 | 缺点 | 适用场景 |
|------|------|------|---------|
| **A. LLM 自主规划** | 灵活，无需预定义 | Token 消耗大，可能出错 | 复杂、非标准化任务 |
| **B. 预定义工作流** | 可靠，可预测 | 不够灵活 | 标准化、高频任务 |
| **C. 混合模式** | 兼顾灵活性和可靠性 | 实现复杂度高 | 通用场景 |

**推荐: 采用混合模式 (方案 C)**
- 高频标准任务 → 预定义工作流
- 复杂非标准任务 → LLM 自主规划
- 系统提供规划辅助工具

### 2.2 架构设计

```
┌─────────────────────────────────────────────────────────────────┐
│                         用户请求                                 │
│            "帮我屏蔽生产业务组下所有主机的告警"                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      意图分析 (LLM)                              │
│  识别: 这是一个多步骤任务，需要编排执行                           │
└─────────────────────────────────────────────────────────────────┘
                                │
                    ┌───────────┴───────────┐
                    ▼                       ▼
        ┌─────────────────┐       ┌─────────────────┐
        │  匹配预定义工作流? │       │  LLM 自主规划    │
        │     (优先)       │       │   (Fallback)    │
        └─────────────────┘       └─────────────────┘
                    │                       │
                    └───────────┬───────────┘
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      执行计划 (Execution Plan)                   │
│  Step 1: query_busi_group → $group_id                           │
│  Step 2: query_targets(group_id=$group_id) → $targets           │
│  Step 3: create_alert_mute(targets=$targets)                    │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      编排执行器 (Orchestrator)                   │
│  - 按依赖顺序执行                                                │
│  - 变量替换与传递                                                │
│  - 错误处理与重试                                                │
│  - 执行进度跟踪                                                  │
└─────────────────────────────────────────────────────────────────┘
                                │
                                ▼
┌─────────────────────────────────────────────────────────────────┐
│                      结果汇总 (LLM)                              │
│  "已成功为生产业务组下的 15 台主机创建了 2 小时的告警屏蔽"         │
└─────────────────────────────────────────────────────────────────┘
```

---

## 3. 执行计划 (Execution Plan) 规范

### 3.1 计划结构定义

```json
{
  "plan_id": "plan_20240116_001",
  "name": "批量创建告警屏蔽",
  "description": "为指定业务组下的所有主机创建告警屏蔽",
  "variables": {
    "group_name": { "type": "string", "source": "user_input", "value": "生产业务组" },
    "duration": { "type": "integer", "source": "user_input", "value": 7200 }
  },
  "steps": [
    {
      "id": "step_1",
      "name": "查询业务组",
      "tool": "busi_group_list",
      "parameters": {
        "query": "${group_name}"
      },
      "output": {
        "group_id": "$.dat[0].id",
        "group_name_actual": "$.dat[0].name"
      },
      "on_error": "abort"
    },
    {
      "id": "step_2",
      "name": "查询主机列表",
      "tool": "target_list",
      "depends_on": ["step_1"],
      "parameters": {
        "group_ids": "${step_1.group_id}"
      },
      "output": {
        "targets": "$.dat.list[*].ident",
        "target_count": "$.dat.total"
      },
      "condition": "${step_1.group_id} != null",
      "on_error": "abort"
    },
    {
      "id": "step_3",
      "name": "创建告警屏蔽",
      "tool": "alert_mute_create",
      "depends_on": ["step_2"],
      "parameters": {
        "group_id": "${step_1.group_id}",
        "tags": [
          { "key": "ident", "func": "in", "value": "${step_2.targets}" }
        ],
        "btime": "${NOW}",
        "etime": "${NOW + duration}",
        "note": "AI助手自动创建: 屏蔽 ${step_1.group_name_actual} 下的主机"
      },
      "output": {
        "mute_id": "$.dat.id"
      },
      "confirm_required": true,
      "confirm_message": "即将为 ${step_2.target_count} 台主机创建 ${duration/3600} 小时的告警屏蔽，是否继续？",
      "on_error": "abort"
    }
  ],
  "summary_template": "已成功为「${step_1.group_name_actual}」业务组下的 ${step_2.target_count} 台主机创建告警屏蔽，屏蔽ID: ${step_3.mute_id}，持续时间: ${duration/3600} 小时"
}
```

### 3.2 核心字段说明

#### 3.2.1 变量系统 (Variables)

```json
{
  "variables": {
    "group_name": {
      "type": "string",
      "source": "user_input",      // user_input | default | computed
      "value": "生产业务组",
      "required": true
    },
    "duration": {
      "type": "integer",
      "source": "default",
      "value": 3600,
      "description": "屏蔽持续时间(秒)"
    }
  }
}
```

**变量来源**:
- `user_input`: 从用户输入中提取
- `default`: 使用默认值
- `computed`: 通过表达式计算
- `context`: 从会话上下文获取 (如当前用户ID)

#### 3.2.2 步骤定义 (Steps)

```json
{
  "id": "step_1",
  "name": "步骤显示名称",
  "tool": "工具名称",
  "depends_on": ["前置步骤ID"],
  "condition": "执行条件表达式",
  "parameters": { "参数映射" },
  "output": { "输出变量映射" },
  "on_error": "错误处理策略",
  "retry": { "重试配置" },
  "timeout": 30000,
  "confirm_required": false,
  "confirm_message": "确认提示信息"
}
```

#### 3.2.3 变量引用语法

| 语法 | 说明 | 示例 |
|------|------|------|
| `${var_name}` | 引用全局变量 | `${duration}` |
| `${step_id.output_key}` | 引用步骤输出 | `${step_1.group_id}` |
| `${NOW}` | 当前时间戳 | `${NOW}` |
| `${NOW + 3600}` | 时间计算 | `${NOW + duration}` |
| `${USER_ID}` | 当前用户ID | `${USER_ID}` |
| `$.json.path` | JSONPath 提取 | `$.dat.list[0].id` |

#### 3.2.4 输出映射 (Output Mapping)

使用 JSONPath 从 API 响应中提取数据：

```json
{
  "output": {
    "group_id": "$.dat[0].id",           // 提取第一个结果的 ID
    "all_ids": "$.dat[*].id",            // 提取所有 ID 为数组
    "total": "$.dat.total",              // 提取 total 字段
    "first_name": "$.dat.list[0].name"   // 嵌套路径
  }
}
```

#### 3.2.5 条件执行 (Condition)

```json
{
  "condition": "${step_1.target_count} > 0",
  "skip_message": "未找到符合条件的主机，跳过屏蔽步骤"
}
```

支持的条件表达式：
- 比较: `==`, `!=`, `>`, `<`, `>=`, `<=`
- 逻辑: `&&`, `||`, `!`
- 存在检查: `!= null`, `== null`
- 数组: `contains`, `length`

#### 3.2.6 错误处理 (Error Handling)

```json
{
  "on_error": "abort",              // abort | skip | retry | fallback
  "retry": {
    "max_attempts": 3,
    "delay_ms": 1000,
    "backoff": "exponential"        // fixed | linear | exponential
  },
  "fallback": {
    "tool": "备用工具",
    "parameters": {}
  }
}
```

| 策略 | 行为 |
|------|------|
| `abort` | 立即终止整个计划 |
| `skip` | 跳过当前步骤，继续执行 |
| `retry` | 按配置重试 |
| `fallback` | 执行备用工具 |

---

## 4. 预定义工作流

### 4.1 工作流模板表设计

```sql
CREATE TABLE `ai_workflow_template` (
    `id` bigint PRIMARY KEY AUTO_INCREMENT,
    `name` varchar(128) NOT NULL UNIQUE COMMENT '工作流名称',
    `display_name` varchar(128) NOT NULL COMMENT '显示名称',
    `description` text NOT NULL COMMENT '工作流描述，供 LLM 匹配',
    `category` varchar(64) COMMENT '分类',
    
    -- 触发配置
    `keywords` text COMMENT '触发关键词 JSON 数组',
    `intent_patterns` text COMMENT '意图匹配模式 (正则表达式数组)',
    
    -- 工作流定义
    `plan_template` text NOT NULL COMMENT '执行计划模板 JSON',
    `input_schema` text COMMENT '输入参数 JSON Schema',
    
    -- 元信息
    `risk_level` varchar(16) DEFAULT 'medium',
    `enabled` tinyint(1) DEFAULT 1,
    `usage_count` bigint DEFAULT 0 COMMENT '使用次数统计',
    
    `created_at` bigint,
    `updated_at` bigint,
    
    INDEX `idx_category` (`category`),
    INDEX `idx_enabled` (`enabled`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='AI 工作流模板';
```

### 4.2 预定义工作流示例

#### 工作流 1: 批量主机告警屏蔽

```json
{
  "name": "batch_host_mute",
  "display_name": "批量主机告警屏蔽",
  "description": "为指定业务组、标签或主机列表创建告警屏蔽",
  "keywords": ["屏蔽", "静默", "批量屏蔽", "业务组屏蔽"],
  "intent_patterns": [
    "屏蔽.*业务组.*告警",
    "屏蔽.*所有.*主机",
    "批量.*屏蔽"
  ],
  "input_schema": {
    "type": "object",
    "properties": {
      "scope_type": {
        "type": "string",
        "enum": ["busi_group", "tag", "hosts"],
        "description": "屏蔽范围类型"
      },
      "scope_value": {
        "type": "string",
        "description": "范围值：业务组名/标签/主机列表"
      },
      "duration_hours": {
        "type": "number",
        "default": 1,
        "description": "屏蔽时长(小时)"
      },
      "reason": {
        "type": "string",
        "description": "屏蔽原因"
      }
    },
    "required": ["scope_type", "scope_value"]
  },
  "plan_template": {
    "steps": [
      {
        "id": "resolve_scope",
        "name": "解析屏蔽范围",
        "tool": "native:resolve_mute_scope",
        "parameters": {
          "scope_type": "${scope_type}",
          "scope_value": "${scope_value}"
        },
        "output": {
          "group_id": "$.group_id",
          "tags": "$.tags",
          "target_count": "$.target_count"
        }
      },
      {
        "id": "create_mute",
        "name": "创建屏蔽规则",
        "tool": "alert_mute_create",
        "depends_on": ["resolve_scope"],
        "parameters": {
          "group_id": "${resolve_scope.group_id}",
          "tags": "${resolve_scope.tags}",
          "btime": "${NOW}",
          "etime": "${NOW + duration_hours * 3600}",
          "note": "${reason}"
        },
        "confirm_required": true,
        "confirm_message": "将屏蔽 ${resolve_scope.target_count} 个目标的告警 ${duration_hours} 小时，确认执行？"
      }
    ]
  }
}
```

#### 工作流 2: 告警规则克隆

```json
{
  "name": "clone_alert_rule",
  "display_name": "克隆告警规则",
  "description": "将告警规则复制到另一个业务组",
  "keywords": ["复制规则", "克隆规则", "迁移规则"],
  "plan_template": {
    "steps": [
      {
        "id": "get_rule",
        "name": "获取原规则",
        "tool": "alert_rule_get",
        "parameters": { "rule_id": "${source_rule_id}" },
        "output": { "rule": "$.dat" }
      },
      {
        "id": "find_target_group",
        "name": "查找目标业务组",
        "tool": "busi_group_list",
        "parameters": { "query": "${target_group_name}" },
        "output": { "target_group_id": "$.dat[0].id" }
      },
      {
        "id": "create_rule",
        "name": "创建新规则",
        "tool": "alert_rule_create",
        "depends_on": ["get_rule", "find_target_group"],
        "parameters": {
          "group_id": "${find_target_group.target_group_id}",
          "name": "${get_rule.rule.name} (副本)",
          "...": "${get_rule.rule}"
        },
        "output": { "new_rule_id": "$.dat.id" }
      }
    ],
    "summary_template": "已将规则「${get_rule.rule.name}」克隆到业务组「${target_group_name}」，新规则ID: ${create_rule.new_rule_id}"
  }
}
```

#### 工作流 3: 数据库慢查询处理

```json
{
  "name": "handle_slow_query",
  "display_name": "慢查询诊断与处理",
  "description": "查询慢SQL，分析原因，可选择终止会话",
  "keywords": ["慢查询", "慢SQL", "长时间SQL", "kill查询"],
  "plan_template": {
    "steps": [
      {
        "id": "query_slow",
        "name": "查询慢SQL",
        "tool": "dbm_slow_queries",
        "parameters": {
          "instance_id": "${instance_id}",
          "min_duration": "${min_duration_seconds}"
        },
        "output": {
          "slow_queries": "$.dat.list",
          "count": "$.dat.total"
        }
      },
      {
        "id": "analyze",
        "name": "分析慢查询",
        "tool": "native:analyze_slow_queries",
        "depends_on": ["query_slow"],
        "condition": "${query_slow.count} > 0",
        "parameters": {
          "queries": "${query_slow.slow_queries}"
        },
        "output": {
          "analysis": "$.analysis",
          "killable_sessions": "$.killable_session_ids"
        }
      },
      {
        "id": "kill_sessions",
        "name": "终止会话",
        "tool": "dbm_kill_sessions",
        "depends_on": ["analyze"],
        "condition": "${user_confirmed_kill} == true && length(${analyze.killable_sessions}) > 0",
        "parameters": {
          "instance_id": "${instance_id}",
          "session_ids": "${analyze.killable_sessions}"
        },
        "confirm_required": true,
        "confirm_message": "将终止 ${length(analyze.killable_sessions)} 个会话，此操作不可撤销，确认执行？"
      }
    ]
  }
}
```

---

## 5. LLM 自主规划

### 5.1 规划 Prompt 设计

当没有匹配的预定义工作流时，LLM 自主生成执行计划：

```
你是一个任务规划专家。根据用户请求，生成一个多步骤执行计划。

## 可用工具
${available_tools_with_schemas}

## 规划规则
1. 分析任务需要哪些步骤
2. 识别步骤之间的数据依赖
3. 使用 ${step_id.output_key} 引用前序步骤的输出
4. 对于删除/修改操作，设置 confirm_required: true
5. 输出标准的 Plan JSON 格式

## 用户请求
${user_request}

## 输出格式
返回一个符合以下结构的 JSON:
{
  "analysis": "任务分析说明",
  "steps": [
    {
      "id": "step_1",
      "name": "步骤名称",
      "tool": "工具名称",
      "parameters": {},
      "output": {},
      "depends_on": []
    }
  ],
  "summary_template": "执行完成后的汇总模板"
}
```

### 5.2 规划示例

**用户输入**: "查看 db-master-01 上运行超过 30 分钟的查询，如果有就发告警通知给 DBA 组"

**LLM 规划输出**:
```json
{
  "analysis": "需要先查询数据库会话，筛选长时间运行的查询，然后发送通知",
  "steps": [
    {
      "id": "find_instance",
      "name": "查找数据库实例",
      "tool": "dbm_instance_list",
      "parameters": { "query": "db-master-01" },
      "output": { "instance_id": "$.dat.list[0].id" }
    },
    {
      "id": "get_sessions",
      "name": "获取会话列表",
      "tool": "dbm_sessions",
      "depends_on": ["find_instance"],
      "parameters": { 
        "instance_id": "${find_instance.instance_id}",
        "min_time": 1800
      },
      "output": { 
        "sessions": "$.dat.list",
        "count": "$.dat.total"
      }
    },
    {
      "id": "send_notify",
      "name": "发送通知",
      "tool": "notify_send",
      "depends_on": ["get_sessions"],
      "condition": "${get_sessions.count} > 0",
      "parameters": {
        "channel": "dba_group",
        "title": "慢查询告警: db-master-01",
        "content": "发现 ${get_sessions.count} 个运行超过30分钟的查询"
      }
    }
  ],
  "summary_template": "检查完成。${get_sessions.count > 0 ? '已向 DBA 组发送通知' : '未发现长时间运行的查询'}"
}
```

---

## 6. 编排执行器

### 6.1 执行流程

```
┌─────────────────────────────────────────────────────────────────┐
│                        Orchestrator                              │
└─────────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐
│ 1. 解析计划    │ ─── 验证 JSON 结构，构建依赖图
└───────────────┘
        │
        ▼
┌───────────────┐
│ 2. 变量初始化  │ ─── 解析用户输入，设置上下文变量
└───────────────┘
        │
        ▼
┌───────────────┐     ┌─────────────────────────────────┐
│ 3. 拓扑排序    │ ──▶ │  step_1 → step_2 → step_3      │
└───────────────┘     │       ↘      ↗                  │
                      │        step_2b (可并行)          │
                      └─────────────────────────────────┘
        │
        ▼
┌───────────────────────────────────────────────────────────────┐
│ 4. 循环执行                                                    │
│   ┌─────────────────────────────────────────────────────────┐ │
│   │ 4.1 检查条件 (condition)                                 │ │
│   │ 4.2 变量替换 (${...})                                    │ │
│   │ 4.3 用户确认 (confirm_required)                          │ │
│   │ 4.4 执行工具 (Tool Executor)                             │ │
│   │ 4.5 提取输出 (JSONPath)                                  │ │
│   │ 4.6 更新上下文                                           │ │
│   │ 4.7 错误处理 (on_error)                                  │ │
│   └─────────────────────────────────────────────────────────┘ │
└───────────────────────────────────────────────────────────────┘
        │
        ▼
┌───────────────┐
│ 5. 生成汇总    │ ─── 使用 summary_template 渲染结果
└───────────────┘
```

### 6.2 执行上下文

```json
{
  "plan_id": "plan_001",
  "session_id": "session_xxx",
  "user_id": 1,
  "started_at": 1705395600,
  "status": "running",
  
  "variables": {
    "group_name": "生产业务组",
    "duration": 7200,
    "NOW": 1705395600,
    "USER_ID": 1
  },
  
  "step_results": {
    "step_1": {
      "status": "completed",
      "started_at": 1705395601,
      "completed_at": 1705395602,
      "output": {
        "group_id": 5,
        "group_name_actual": "生产业务组"
      }
    },
    "step_2": {
      "status": "running",
      "started_at": 1705395603
    },
    "step_3": {
      "status": "pending"
    }
  },
  
  "current_step": "step_2",
  "pending_confirmation": null,
  "errors": []
}
```

### 6.3 并行执行

当多个步骤没有相互依赖时，可以并行执行：

```json
{
  "steps": [
    { "id": "step_1", "depends_on": [] },
    { "id": "step_2a", "depends_on": ["step_1"] },
    { "id": "step_2b", "depends_on": ["step_1"] },  // 与 step_2a 并行
    { "id": "step_3", "depends_on": ["step_2a", "step_2b"] }  // 等待两者完成
  ]
}
```

执行器自动识别并行机会：
```
Timeline:
─────────────────────────────────────────────────>
│ step_1 │
         ├─ step_2a ─┤
         ├─ step_2b ─┤  (并行)
                     │ step_3 │
```

---

## 7. 用户交互

### 7.1 确认机制

对于高风险操作，执行器会暂停并请求用户确认：

```json
{
  "type": "confirmation_request",
  "step_id": "step_3",
  "step_name": "创建告警屏蔽",
  "message": "即将为 15 台主机创建 2 小时的告警屏蔽，是否继续？",
  "risk_level": "medium",
  "preview": {
    "targets": ["host-01", "host-02", "...共15台"],
    "duration": "2小时",
    "effect": "这些主机在屏蔽期间不会产生告警"
  },
  "options": [
    { "action": "confirm", "label": "确认执行" },
    { "action": "modify", "label": "修改参数" },
    { "action": "cancel", "label": "取消操作" }
  ]
}
```

### 7.2 进度展示

```json
{
  "type": "progress_update",
  "plan_id": "plan_001",
  "total_steps": 3,
  "completed_steps": 1,
  "current_step": {
    "id": "step_2",
    "name": "查询主机列表",
    "status": "running"
  },
  "timeline": [
    { "step": "step_1", "name": "查询业务组", "status": "completed", "duration_ms": 150 },
    { "step": "step_2", "name": "查询主机列表", "status": "running" },
    { "step": "step_3", "name": "创建告警屏蔽", "status": "pending" }
  ]
}
```

### 7.3 错误恢复

```json
{
  "type": "error_report",
  "step_id": "step_2",
  "error": {
    "code": "API_ERROR",
    "message": "查询超时",
    "details": "..."
  },
  "recovery_options": [
    { "action": "retry", "label": "重试" },
    { "action": "skip", "label": "跳过此步骤" },
    { "action": "abort", "label": "终止计划" },
    { "action": "manual", "label": "手动处理", "hint": "请在系统中手动完成此操作" }
  ]
}
```

---

## 8. 执行日志

### 8.1 日志表设计

```sql
CREATE TABLE `ai_plan_execution` (
    `id` bigint PRIMARY KEY AUTO_INCREMENT,
    `plan_id` varchar(64) NOT NULL,
    `session_id` varchar(64) NOT NULL,
    `user_id` bigint NOT NULL,
    
    -- 计划信息
    `plan_name` varchar(128),
    `plan_source` varchar(32) COMMENT 'workflow_template | llm_planned',
    `workflow_template_id` bigint COMMENT '关联的工作流模板ID',
    `plan_json` text COMMENT '完整的执行计划',
    
    -- 执行状态
    `status` varchar(32) COMMENT 'running | completed | failed | cancelled | pending_confirm',
    `current_step` varchar(64),
    `progress` int COMMENT '完成百分比',
    
    -- 输入输出
    `input_variables` text,
    `step_results` text COMMENT '各步骤执行结果 JSON',
    `final_output` text,
    
    -- 时间信息
    `started_at` bigint,
    `completed_at` bigint,
    `total_duration_ms` int,
    
    -- 错误信息
    `error_step` varchar(64),
    `error_message` text,
    
    INDEX `idx_session` (`session_id`),
    INDEX `idx_user` (`user_id`),
    INDEX `idx_status` (`status`),
    INDEX `idx_started_at` (`started_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

---

## 9. 设计总结

### 9.1 核心能力

| 能力 | 实现方式 |
|------|---------|
| **多步骤执行** | 执行计划 + 编排执行器 |
| **数据传递** | 变量系统 + JSONPath 提取 |
| **条件分支** | condition 表达式 |
| **并行执行** | 依赖图拓扑排序 |
| **错误处理** | on_error 策略 + 重试机制 |
| **用户确认** | confirm_required + 交互协议 |
| **灵活性** | 预定义工作流 + LLM 自主规划 |

### 9.2 使用场景匹配

| 场景类型 | 推荐方案 |
|---------|---------|
| 高频标准操作 | 预定义工作流模板 |
| 复杂一次性任务 | LLM 自主规划 |
| 需要人工决策的流程 | 带确认点的工作流 |
| 批量操作 | 循环步骤 + 并行执行 |

### 9.3 与文档 13 的关系

```
文档 13 (单工具调用)          文档 14 (多步骤编排)
┌─────────────────┐          ┌─────────────────────────┐
│   ai_tool 表     │◀─────────│   ai_workflow_template  │
│   工具定义       │  引用     │   工作流模板             │
│   单次 API 调用  │          │   多步骤计划             │
└─────────────────┘          └─────────────────────────┘
         │                              │
         ▼                              ▼
┌─────────────────┐          ┌─────────────────────────┐
│  Tool Executor  │◀─────────│     Orchestrator        │
│  单工具执行器    │  调用     │     编排执行器           │
└─────────────────┘          └─────────────────────────┘
```

文档 13 定义的单工具是本文档多步骤编排的基础构建块。
