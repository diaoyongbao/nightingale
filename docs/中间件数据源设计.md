# 中间件数据源设计文档

## 一、需求概述

### 1.1 背景
当前 Archery 的配置是硬编码在配置文件中,需要改造为可以动态配置的中间件数据源系统,支持 Archery、JumpServer、Jenkins 等多种运维中间件。

### 1.2 核心需求
1. 支持多种中间件类型(Archery、JumpServer、Jenkins 等)
2. 支持不同的鉴权方式(Token、Basic Auth、Session、OAuth 等)
3. 配置存储在数据库中,支持动态增删改查
4. 敏感信息(密码、Token)支持加密存储
5. 支持健康检查和状态监控
6. 支持多实例配置(同一中间件可配置多个实例)

## 二、数据库表设计

### 2.1 中间件数据源表 (middleware_datasource)

```sql
CREATE TABLE `middleware_datasource` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT COMMENT '主键ID',
  `name` varchar(191) NOT NULL COMMENT '数据源名称',
  `type` varchar(64) NOT NULL COMMENT '中间件类型: archery, jumpserver, jenkins, gitlab, etc.',
  `description` varchar(500) DEFAULT '' COMMENT '描述信息',
  `address` varchar(500) NOT NULL COMMENT '中间件地址 URL',
  `status` varchar(32) DEFAULT 'enabled' COMMENT '状态: enabled, disabled',
  
  -- 连接配置
  `timeout` int DEFAULT 5000 COMMENT '请求超时时间(毫秒)',
  `connect_timeout` int DEFAULT 2000 COMMENT '连接超时时间(毫秒)',
  `insecure_skip_verify` tinyint(1) DEFAULT 0 COMMENT '是否跳过 SSL 验证',
  
  -- 认证配置
  `auth_type` varchar(32) NOT NULL COMMENT '认证类型: token, basic, session, oauth2, none',
  `auth_config` text COMMENT '认证配置 JSON (加密存储)',
  `auth_config_encoded` text COMMENT '加密后的认证配置',
  
  -- 扩展配置
  `settings` text COMMENT '扩展配置 JSON',
  `settings_encoded` text COMMENT '加密后的扩展配置',
  
  -- 健康检查
  `health_check_url` varchar(500) DEFAULT '' COMMENT '健康检查 URL',
  `health_check_interval` int DEFAULT 60 COMMENT '健康检查间隔(秒)',
  `last_health_check` bigint DEFAULT 0 COMMENT '最后健康检查时间',
  `health_status` varchar(32) DEFAULT 'unknown' COMMENT '健康状态: healthy, unhealthy, unknown',
  `health_message` varchar(500) DEFAULT '' COMMENT '健康检查消息',
  
  -- 元信息
  `tags` varchar(500) DEFAULT '' COMMENT '标签,逗号分隔',
  `order_num` int DEFAULT 0 COMMENT '排序号',
  `created_at` bigint NOT NULL COMMENT '创建时间',
  `created_by` varchar(64) NOT NULL COMMENT '创建人',
  `updated_at` bigint NOT NULL COMMENT '更新时间',
  `updated_by` varchar(64) NOT NULL COMMENT '更新人',
  
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_name` (`name`),
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='中间件数据源配置表';
```

### 2.2 字段说明

#### 基础字段
- `id`: 主键
- `name`: 数据源名称,全局唯一,用于标识该中间件实例
- `type`: 中间件类型,如: archery, jumpserver, jenkins, gitlab 等
- `description`: 描述信息
- `address`: 中间件访问地址,如: http://archery.example.com
- `status`: 启用状态,enabled(启用) / disabled(禁用)

#### 连接配置
- `timeout`: HTTP 请求超时时间(毫秒)
- `connect_timeout`: TCP 连接超时时间(毫秒)
- `insecure_skip_verify`: 是否跳过 HTTPS 证书验证

#### 认证配置
- `auth_type`: 认证类型
  - `token`: Bearer Token 或 API Token
  - `basic`: HTTP Basic Auth
  - `session`: Session Cookie
  - `oauth2`: OAuth2 认证
  - `none`: 无需认证
- `auth_config`: 认证配置 JSON,根据不同 auth_type 存储不同结构
- `auth_config_encoded`: RSA 加密后的认证配置

#### 扩展配置
- `settings`: 中间件特定的扩展配置 JSON
- `settings_encoded`: 加密后的扩展配置

#### 健康检查
- `health_check_url`: 健康检查接口 URL
- `health_check_interval`: 健康检查间隔(秒)
- `last_health_check`: 最后一次健康检查时间戳
- `health_status`: 健康状态
- `health_message`: 健康检查返回的消息

#### 元信息
- `tags`: 标签,用于分类和过滤
- `order_num`: 排序号,用于前端展示排序
- `created_at/by`: 创建时间和创建人
- `updated_at/by`: 更新时间和更新人

## 三、认证配置 (auth_config) 结构

### 3.1 Token 认证
```json
{
  "token": "Bearer eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9...",
  "header_name": "Authorization",
  "header_prefix": "Bearer"
}
```

### 3.2 Basic Auth 认证
```json
{
  "username": "admin",
  "password": "password123"
}
```

### 3.3 Session 认证
```json
{
  "username": "admin",
  "password": "password123",
  "login_url": "/api/login",
  "cookie_name": "sessionid"
}
```

### 3.4 OAuth2 认证
```json
{
  "client_id": "your-client-id",
  "client_secret": "your-client-secret",
  "token_url": "https://auth.example.com/oauth/token",
  "scopes": ["read", "write"]
}
```

## 四、扩展配置 (settings) 示例

### 4.1 Archery 扩展配置
```json
{
  "api_version": "v1",
  "features": {
    "sql_query": true,
    "sql_check": true,
    "slow_query": true,
    "session_management": true
  },
  "default_db_type": "mysql"
}
```

### 4.2 JumpServer 扩展配置
```json
{
  "api_version": "v2",
  "asset_group_id": "default",
  "protocol": "ssh",
  "port": 22
}
```

### 4.3 Jenkins 扩展配置
```json
{
  "api_version": "2.0",
  "crumb_required": true,
  "job_base_path": "/job"
}
```

## 五、Go 模型定义

```go
package models

import (
    "encoding/json"
    "time"
    "github.com/ccfos/nightingale/v6/pkg/ctx"
    "gorm.io/gorm"
)

// MiddlewareDatasource 中间件数据源模型
type MiddlewareDatasource struct {
    Id                   int64                  `json:"id" gorm:"primaryKey"`
    Name                 string                 `json:"name" gorm:"uniqueIndex;not null"`
    Type                 string                 `json:"type" gorm:"index;not null"`
    Description          string                 `json:"description"`
    Address              string                 `json:"address" gorm:"not null"`
    Status               string                 `json:"status" gorm:"index;default:enabled"`
    
    // 连接配置
    Timeout              int                    `json:"timeout" gorm:"default:5000"`
    ConnectTimeout       int                    `json:"connect_timeout" gorm:"default:2000"`
    InsecureSkipVerify   bool                   `json:"insecure_skip_verify" gorm:"default:false"`
    
    // 认证配置
    AuthType             string                 `json:"auth_type" gorm:"not null"`
    AuthConfig           string                 `json:"-" gorm:"column:auth_config;type:text"`
    AuthConfigJson       map[string]interface{} `json:"auth_config" gorm:"-"`
    AuthConfigEncoded    string                 `json:"auth_config_encoded,omitempty" gorm:"column:auth_config_encoded;type:text"`
    
    // 扩展配置
    Settings             string                 `json:"-" gorm:"column:settings;type:text"`
    SettingsJson         map[string]interface{} `json:"settings" gorm:"-"`
    SettingsEncoded      string                 `json:"settings_encoded,omitempty" gorm:"column:settings_encoded;type:text"`
    
    // 健康检查
    HealthCheckUrl       string                 `json:"health_check_url"`
    HealthCheckInterval  int                    `json:"health_check_interval" gorm:"default:60"`
    LastHealthCheck      int64                  `json:"last_health_check" gorm:"default:0"`
    HealthStatus         string                 `json:"health_status" gorm:"default:unknown"`
    HealthMessage        string                 `json:"health_message"`
    
    // 元信息
    Tags                 string                 `json:"tags"`
    OrderNum             int                    `json:"order_num" gorm:"default:0"`
    CreatedAt            int64                  `json:"created_at" gorm:"not null"`
    CreatedBy            string                 `json:"created_by" gorm:"not null"`
    UpdatedAt            int64                  `json:"updated_at" gorm:"not null"`
    UpdatedBy            string                 `json:"updated_by" gorm:"not null"`
}

func (MiddlewareDatasource) TableName() string {
    return "middleware_datasource"
}

// 常量定义
const (
    // 中间件类型
    MiddlewareTypeArchery     = "archery"
    MiddlewareTypeJumpServer  = "jumpserver"
    MiddlewareTypeJenkins     = "jenkins"
    MiddlewareTypeGitLab      = "gitlab"
    
    // 认证类型
    AuthTypeToken    = "token"
    AuthTypeBasic    = "basic"
    AuthTypeSession  = "session"
    AuthTypeOAuth2   = "oauth2"
    AuthTypeNone     = "none"
    
    // 状态
    StatusEnabled  = "enabled"
    StatusDisabled = "disabled"
    
    // 健康状态
    HealthStatusHealthy   = "healthy"
    HealthStatusUnhealthy = "unhealthy"
    HealthStatusUnknown   = "unknown"
)
```

## 六、迁移方案

### 6.1 从配置文件迁移到数据库

1. **读取现有配置**: 从 `conf.Integrations.Archery` 读取现有配置
2. **转换为数据库记录**: 创建 MiddlewareDatasource 记录
3. **数据迁移脚本**: 提供一键迁移脚本
4. **兼容性处理**: 
   - 如果数据库中没有配置,则从配置文件读取(向后兼容)
   - 优先使用数据库配置
   - 提供配置导入导出功能

### 6.2 迁移脚本示例

```go
// 从配置文件迁移 Archery 配置到数据库
func MigrateArcheryConfig(ctx *ctx.Context, archeryConf dbm.ArcheryConfig) error {
    if !archeryConf.Enable {
        return nil
    }
    
    // 检查是否已存在
    exists, _ := MiddlewareDatasourceExists(ctx, "archery-default")
    if exists {
        return nil // 已迁移过
    }
    
    // 构建认证配置
    authConfig := make(map[string]interface{})
    if archeryConf.AuthType == "token" {
        authConfig["token"] = archeryConf.AuthToken
        authConfig["header_name"] = "Authorization"
        authConfig["header_prefix"] = "Bearer"
    } else if archeryConf.AuthType == "basic" {
        authConfig["username"] = archeryConf.Username
        authConfig["password"] = archeryConf.Password
    }
    
    // 创建数据源记录
    ds := &MiddlewareDatasource{
        Name:                "archery-default",
        Type:                MiddlewareTypeArchery,
        Description:         "从配置文件自动迁移的 Archery 实例",
        Address:             archeryConf.Address,
        Status:              StatusEnabled,
        Timeout:             archeryConf.Timeout,
        ConnectTimeout:      archeryConf.ConnectTimeout,
        InsecureSkipVerify:  archeryConf.InsecureSkipVerify,
        AuthType:            archeryConf.AuthType,
        AuthConfigJson:      authConfig,
        HealthCheckUrl:      "/api/health/",
        HealthCheckInterval: 60,
        CreatedAt:           time.Now().Unix(),
        CreatedBy:           "system",
        UpdatedAt:           time.Now().Unix(),
        UpdatedBy:           "system",
    }
    
    return ds.Add(ctx)
}
```

## 七、API 接口设计

### 7.1 中间件数据源管理接口

```
GET    /api/n9e/middleware-datasources           # 获取中间件数据源列表
POST   /api/n9e/middleware-datasources           # 创建中间件数据源
GET    /api/n9e/middleware-datasources/:id       # 获取单个中间件数据源
PUT    /api/n9e/middleware-datasources/:id       # 更新中间件数据源
DELETE /api/n9e/middleware-datasources/:id       # 删除中间件数据源
POST   /api/n9e/middleware-datasources/:id/test  # 测试连接
GET    /api/n9e/middleware-datasources/types     # 获取支持的中间件类型列表
```

### 7.2 查询参数
```
?type=archery          # 按类型筛选
?status=enabled        # 按状态筛选
?keyword=xxx           # 按名称/描述搜索
?page=1&limit=20       # 分页
```

## 八、前端改造

### 8.1 菜单结构调整
```
系统管理
  ├── 中间件数据源管理    (新增)
  │   ├── Archery
  │   ├── JumpServer
  │   └── Jenkins
  └── 数据源管理         (原有)
```

### 8.2 页面功能
1. **列表页**: 展示所有中间件数据源,支持筛选、搜索
2. **新增/编辑页**: 表单式配置
3. **健康检查**: 实时显示健康状态,支持手动触发
4. **测试连接**: 保存前可测试连接

## 九、优势与扩展性

### 9.1 优势
1. **灵活配置**: 无需修改代码和配置文件,通过界面即可管理
2. **多实例支持**: 可配置多个相同类型的中间件
3. **安全性**: 敏感信息加密存储
4. **可监控**: 内置健康检查机制
5. **可扩展**: 易于添加新的中间件类型

### 9.2 扩展性
- 可轻松添加新的中间件类型(如 Nacos、Consul、Kafka Manager 等)
- 支持自定义认证方式
- 支持插件化扩展

## 十、实施步骤

1. **数据库迁移**: 创建 middleware_datasource 表
2. **模型层**: 实现 MiddlewareDatasource 模型和 CRUD 方法
3. **服务层**: 实现中间件客户端工厂模式
4. **API层**: 实现 RESTful API
5. **配置迁移**: 实现 Archery 配置从文件到数据库的迁移
6. **前端开发**: 实现管理界面
7. **测试**: 功能测试、安全测试
8. **文档**: 更新用户文档和 API 文档
