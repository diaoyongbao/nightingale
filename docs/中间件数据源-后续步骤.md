# 中间件数据源管理 - 后续完成步骤

## 已完成工作 ✅

### 后端 (100%)
1. ✅ 数据库设计 - `middleware_datasource` 表
2. ✅ Model层 - `models/middleware_datasource.go` (完整CRUD)
3. ✅ Migration - 自动建表逻辑
4. ✅ API路由 - 13个完整接口
5. ✅ 健康检查逻辑 - `cron/middleware_health_check.go`
6. ✅ Archery迁移逻辑 - `models/middleware_datasource_migrate.go`
7. ✅ 完整文档 - 4份设计和实施文档

### 前端 (70%)
1. ✅ Service层 - `services/middleware.ts` (类型定义+API封装)
2. ✅ 主页面组件 - `pages/middleware/index.tsx` (列表+筛选+操作)
3. ✅ 表单组件 - `pages/middleware/Form.tsx` (创建/编辑)
4. ✅ 国际化 - `pages/middleware/locale/` (zh_CN + en_US + index.ts)
5. ✅ 菜单配置 - 已在 `components/SideMenu/menu.tsx` 添加菜单项

## 待完成工作 ⏳

### 1. 前端国际化集成 (5分钟)

**文件**: `fe/src/components/SideMenu/locale/zh_CN.ts`

在 `dbm: '数据库管理',` 这一行后面添加:
```typescript
middleware: '中间件数据源',
```

**文件**: `fe/src/components/SideMenu/locale/en_US.ts`

在 `dbm: 'Database Management',` 这一行后面添加:
```typescript
middleware: 'Middleware Datasources',
```

**文件**: `fe/src/components/SideMenu/locale/zh_HK.ts` (可选)

在 `dbm: '數據庫管理',` 这一行后面添加:
```typescript
middleware: '中間件數據源',
```

---

### 2. 前端路由注册 (3分钟)

**文件**: `fe/src/routers/index.tsx`

**步骤1**: 在文件顶部 import 区域,在第73行(`import DBMInstanceList from '@/pages/dbm';`)后面添加:
```typescript
import MiddlewareManage from '@/pages/middleware';
```

**步骤2**: 在第218-221行(DBM路由配置)后面添加:
```typescript
<Route exact path='/middleware' component={MiddlewareManage} />
```

---

### 3. 后端健康检查集成 (2分钟)

**文件**: `nightingale/center/center.go` (或类似的主程序入口)

在center启动逻辑中,添加:
```go
import (
    "github.com/ccfos/nightingale/v7/center/cron"
    // ... 其他imports
)

// 在main函数或center.Run()中添加
func Run(opts ...Option) error {
    // ... 现有代码 ...
    
    // 启动中间件健康检查
    ctx := context.Background()
    go cron.ScheduleMiddlewareHealthCheck(ctx, 60*time.Second)
    
    // ... 后续代码 ...
}
```

---

### 4. 后端Archery自动迁移 (2分钟)

**文件**: `nightingale/center/center.go` (主程序启动)

在center启动时,添加:
```go
import (
    "github.com/ccfos/nightingale/v7/models"
    // ... 其他imports
)

// 在数据库初始化之后
func Run(opts ...Option) error {
    // ... DB初始化代码 ...
    
    // 自动迁移Archery配置
    if config.Center.Integrations.Archery.Enable {
        archeryConf := models.ArcheryConfig{
            Address:  config.Center.Integrations.Archery.Address,
            Username: config.Center.Integrations.Archery.Username,
            Password: config.Center.Integrations.Archery.Password,
            Timeout:  config.Center.Integrations.Archery.Timeout,
        }
        if err := models.MigrateArcheryConfigToDB(ctx, archeryConf); err != nil {
            log.Warnf("Failed to migrate Archery config: %v", err)
        } else {
            log.Info("Archery config migrated to database successfully")
        }
    }
    
    // ... 后续代码 ...
}
```

---

## 验证步骤

### 1. 编译检查
```bash
# 前端
cd fe
npm run build

# 后端
cd nightingale
go build -o n9e ./cmd/center
```

### 2. 启动测试
```bash
# 启动后端
./n9e -c etc/center.conf

# 访问前端
http://localhost:18000/middleware
```

### 3. 功能测试
- ✅ 页面能正常打开
- ✅ 能创建新的middleware数据源
- ✅ 能编辑已有数据源
- ✅ 能删除数据源
- ✅ 能测试连接
- ✅ 健康检查自动更新
- ✅ Archery配置自动迁移

---

## 权限说明

根据 `AGENTS.md` 的权限规范:
- **菜单权限**: `role: ['Admin']` - 只有Admin角色可见
- **API权限**: `/system/middleware` - 后端已配置Admin only
- **菜单显示**: 前端会自动根据用户角色过滤菜单

Admin用户登录后,在"集成中心"菜单下会看到"中间件数据源"选项(位于DBM和内置组件之间)。

---

## 文件清单

### 新增文件 (13个)
**后端** (8个):
1. `nightingale/models/middleware_datasource.go`
2. `nightingale/models/middleware_datasource_migrate.go`
3. `nightingale/models/migrate/migrate_middleware_datasource.go`
4. `nightingale/center/router/router_middleware_datasource.go`
5. `nightingale/center/router/router_middleware_helper.go`
6. `nightingale/center/cron/middleware_health_check.go`
7-10. `nightingale/docs/中间件数据源*.md` (4个文档)

**前端** (5个):
11. `fe/src/services/middleware.ts`
12. `fe/src/pages/middleware/index.tsx`
13. `fe/src/pages/middleware/Form.tsx`
14. `fe/src/pages/middleware/locale/zh_CN.ts`
15. `fe/src/pages/middleware/locale/en_US.ts`
16. `fe/src/pages/middleware/locale/index.ts`

### 修改文件 (3个)
1. `nightingale/models/migrate/migrate.go` - 添加migration调用
2. `nightingale/center/router/router.go` - 注册13个middleware路由
3. `fe/src/components/SideMenu/menu.tsx` - 添加菜单项

### 待修改文件 (5个)
1. `fe/src/components/SideMenu/locale/zh_CN.ts`
2. `fe/src/components/SideMenu/locale/en_US.ts`  
3. `fe/src/components/SideMenu/locale/zh_HK.ts` (可选)
4. `fe/src/routers/index.tsx`
5. `nightingale/center/center.go` (或主程序入口)

---

## 预计完成时间

- 前端国际化: **5分钟**
- 前端路由注册: **3分钟**
- 后端健康检查集成: **2分钟**
- 后端Archery迁移集成: **2分钟**
- 编译验证: **5分钟**
- 功能测试: **10分钟**

**总计**: ~30分钟即可完成剩余工作

---

## API接口总览

| 方法 | 路径 | 说明 |
|------|------|------|
| GET | /api/n9e/middleware-datasources | 列表查询(支持筛选) |
| GET | /api/n9e/middleware-datasources/count | 数量统计 |
| GET | /api/n9e/middleware-datasource/:id | 获取详情 |
| POST | /api/n9e/middleware-datasource | 创建 |
| PUT | /api/n9e/middleware-datasource/:id | 更新 |
| DELETE | /api/n9e/middleware-datasources | 批量删除 |
| POST | /api/n9e/middleware-datasource/:id/test | 测试连接 |
| GET | /api/n9e/middleware-datasource/types | 获取类型列表 |
| GET | /api/n9e/middleware-datasource/by-type | 按类型查询 |
| POST | /api/n9e/middleware-datasources/status | 批量更新状态 |
| GET | /api/n9e/middleware-datasource/:id/export | 导出配置 |
| POST | /api/n9e/middleware-datasource/migrate-archery | Archery迁移 |

所有接口均已实现且已在 `router.go` 中注册。

---

## 支持的中间件类型

1. **Archery** - SQL审核平台
2. **JumpServer** - 堡垒机
3. **Jenkins** - CI/CD
4. **GitLab** - 代码仓库
5. **Nacos** - 配置中心
6. **Consul** - 服务发现

## 支持的认证方式

1. **Token** - API Token认证
2. **Basic Auth** - 用户名密码
3. **Session** - 会话登录
4. **OAuth2** - OAuth2.0
5. **None** - 无需认证

---

**状态**: 后端100%完成,前端70%完成,剩余30分钟工作量即可交付使用。
