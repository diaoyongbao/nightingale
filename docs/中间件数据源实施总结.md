# 中间件数据源实施总结

## 已完成的工作

### 1. 数据库设计

#### 1.1 表结构设计
已创建 `middleware_datasource` 表,支持:
- ✅ 多种中间件类型 (Archery、JumpServer、Jenkins 等)
- ✅ 多种鉴权方式 (Token、Basic Auth、Session、OAuth2)
- ✅ 敏感信息加密存储 (使用 RSA)
- ✅ 健康检查机制
- ✅ 扩展配置支持

#### 1.2 核心字段
```sql
- id: 主键
- name: 数据源名称 (唯一索引)
- type: 中间件类型 (索引)
- address: 访问地址
- status: 启用状态
- auth_type: 认证类型
- auth_config: 认证配置 (JSON,支持加密)
- settings: 扩展配置 (JSON,支持加密)
- health_check_*: 健康检查相关字段
- created_at/by, updated_at/by: 审计字段
```

### 2. 模型层实现

#### 2.1 核心文件
1. **models/middleware_datasource.go** - 中间件数据源模型
   - ✅ 完整的 CRUD 操作
   - ✅ JSON 配置序列化/反序列化
   - ✅ RSA 加密/解密支持
   - ✅ 数据验证
   - ✅ 认证配置验证

2. **models/middleware_datasource_migrate.go** - 迁移辅助函数
   - ✅ Archery 配置迁移
   - ✅ 配置格式转换
   - ✅ 批量迁移支持

3. **models/migrate/migrate_middleware_datasource.go** - 数据库迁移
   - ✅ 自动建表
   - ✅ 字段增量更新

#### 2.2 提供的方法

**基础 CRUD:**
- `Add()` - 添加中间件数据源
- `Update()` - 更新中间件数据源
- `MiddlewareDatasourceDel()` - 删除
- `MiddlewareDatasourceGet()` - 根据 ID 获取
- `MiddlewareDatasourceGetByName()` - 根据名称获取

**查询方法:**
- `GetMiddlewareDatasources()` - 获取所有
- `GetMiddlewareDatasourcesByType()` - 按类型获取
- `GetMiddlewareDatasourcesBy()` - 复杂查询 (支持分页)
- `GetEnabledMiddlewareDatasourcesByType()` - 获取启用的

**辅助方法:**
- `Encrypt()` / `Decrypt()` - 加密/解密敏感信息
- `UpdateHealthStatus()` - 更新健康状态
- `ValidateAuthConfig()` - 验证认证配置
- `IsEnabled()` / `IsHealthy()` - 状态检查

**迁移方法:**
- `MigrateArcheryConfigToDB()` - 从配置文件迁移 Archery
- `GetArcheryClientFromDB()` - 从数据库获取 Archery 配置
- `ArcheryConfigToMiddlewareDatasource()` - 配置转换

## 下一步工作

### 3. API 层实现 (待实现)

需要在 `center/router/` 中创建以下路由处理:

```go
// router_middleware.go
GET    /api/n9e/middleware-datasources           # 获取列表
POST   /api/n9e/middleware-datasources           # 创建
GET    /api/n9e/middleware-datasources/:id       # 获取详情
PUT    /api/n9e/middleware-datasources/:id       # 更新
DELETE /api/n9e/middleware-datasources/:id       # 删除
POST   /api/n9e/middleware-datasources/:id/test  # 测试连接
GET    /api/n9e/middleware-datasources/types     # 获取支持的类型
POST   /api/n9e/middleware-datasources/migrate   # 从配置文件迁移
```

### 4. 服务层改造 (待实现)

#### 4.1 重构 Archery 客户端
修改 `center/dbm/archery_client.go`:
```go
// 新增: 从数据库配置创建客户端
func NewArcheryClientFromDB(ctx *ctx.Context, name string) (*ArcheryClient, error)

// 修改现有函数,优先从数据库读取配置
func NewArcheryClient(config *ArcheryConfig) (*ArcheryClient, error)
```

#### 4.2 创建中间件工厂
创建 `center/middleware/factory.go`:
```go
type MiddlewareClient interface {
    Type() string
    HealthCheck() error
    Close() error
}

func NewMiddlewareClient(ctx *ctx.Context, id int64) (MiddlewareClient, error)
```

### 5. 集成到现有系统 (待实现)

#### 5.1 在 migrate.go 中注册迁移
修改 `models/migrate/migrate.go`:
```go
func Migrate(db *gorm.DB) {
    MigrateTables(db)
    MigrateEsIndexPatternTable(db)
    MigrateMiddlewareDatasource(db) // 新增
}

func MigrateTables(db *gorm.DB) error {
    // ...
    dts := []interface{}{
        // ... 现有表
        &models.MiddlewareDatasource{}, // 新增
    }
    // ...
}
```

#### 5.2 在启动时触发迁移
修改 `cmd/center/main.go` 或相应启动文件:
```go
// 在数据库初始化后
if config.Integrations.Archery.Enable {
    err := models.MigrateArcheryConfigToDB(ctx, config.Integrations.Archery)
    if err != nil {
        logger.Warningf("failed to migrate archery config: %v", err)
    }
}
```

### 6. 前端开发 (待实现)

#### 6.1 创建页面
在 `fe/src/pages/` 下创建:
```
middleware/
  ├── index.tsx              # 路由入口
  ├── List.tsx               # 列表页
  ├── Form.tsx               # 创建/编辑表单
  ├── Detail.tsx             # 详情页
  ├── TestConnection.tsx     # 测试连接组件
  └── locale/
      ├── zh_CN.ts
      └── en_US.ts
```

#### 6.2 API 服务
创建 `fe/src/services/middleware.ts`:
```typescript
export function getMiddlewareDatasources(params) {
  return request('/api/n9e/middleware-datasources', { params });
}

export function createMiddlewareDatasource(data) {
  return request('/api/n9e/middleware-datasources', { method: 'POST', data });
}

export function updateMiddlewareDatasource(id, data) {
  return request(`/api/n9e/middleware-datasources/${id}`, { method: 'PUT', data });
}

export function deleteMiddlewareDatasource(id) {
  return request(`/api/n9e/middleware-datasources/${id}`, { method: 'DELETE' });
}

export function testMiddlewareConnection(id) {
  return request(`/api/n9e/middleware-datasources/${id}/test`, { method: 'POST' });
}
```

#### 6.3 菜单注册
修改 `fe/src/components/SideMenu/menu.tsx`:
```typescript
{
  key: '/system',
  label: 'menu.system',
  children: [
    {
      key: '/system/middleware',
      label: 'menu.middleware_datasources',
      role: ['Admin'], // Admin 专属
    },
    // ... 其他菜单
  ]
}
```

## 使用示例

### 示例 1: 创建 Archery 数据源

```go
import (
    "github.com/ccfos/nightingale/v6/models"
    "github.com/ccfos/nightingale/v6/pkg/ctx"
)

func createArcheryDatasource(c *ctx.Context, username string) error {
    // 构建认证配置
    authConfig := map[string]interface{}{
        "token":         "your-api-token",
        "header_name":   "Authorization",
        "header_prefix": "Bearer",
    }

    // 构建扩展配置
    settings := map[string]interface{}{
        "api_version": "v1",
        "features": map[string]bool{
            "sql_query":  true,
            "sql_check":  true,
            "slow_query": true,
        },
    }

    // 创建数据源
    ds := &models.MiddlewareDatasource{
        Name:                "archery-prod",
        Type:                models.MiddlewareTypeArchery,
        Description:         "生产环境 Archery",
        Address:             "https://archery.example.com",
        Status:              models.MiddlewareStatusEnabled,
        Timeout:             5000,
        ConnectTimeout:      2000,
        InsecureSkipVerify:  false,
        AuthType:            models.AuthTypeToken,
        AuthConfigJson:      authConfig,
        SettingsJson:        settings,
        HealthCheckUrl:      "/api/health/",
        HealthCheckInterval: 60,
        CreatedBy:           username,
        UpdatedBy:           username,
    }

    return ds.Add(c)
}
```

### 示例 2: 从数据库获取 Archery 配置

```go
import (
    "github.com/ccfos/nightingale/v6/models"
    "github.com/ccfos/nightingale/v6/center/dbm"
)

func getArcheryClient(c *ctx.Context) (*dbm.ArcheryClient, error) {
    // 从数据库获取配置
    config, err := models.GetArcheryClientFromDB(c, "archery-prod")
    if err != nil {
        return nil, err
    }

    // 创建客户端
    client, err := dbm.NewArcheryClient(config)
    if err != nil {
        return nil, err
    }

    return client, nil
}
```

### 示例 3: 从配置文件迁移

```go
import (
    "github.com/ccfos/nightingale/v6/models"
    "github.com/ccfos/nightingale/v6/center/dbm"
)

func migrateArcheryConfig(c *ctx.Context) error {
    // 假设从配置文件读取
    archeryConf := dbm.ArcheryConfig{
        Enable:             true,
        Address:            "http://archery.example.com",
        AuthType:           "token",
        AuthToken:          "your-token",
        Timeout:            5000,
        ConnectTimeout:     2000,
        InsecureSkipVerify: false,
    }

    // 迁移到数据库
    return models.MigrateArcheryConfigToDB(c, archeryConf)
}
```

## 配置迁移路径

### 阶段 1: 兼容模式 (推荐)
1. 保留配置文件中的 `[Integrations.Archery]` 配置
2. 启动时自动迁移到数据库
3. 优先使用数据库配置,配置文件作为后备

### 阶段 2: 纯数据库模式
1. 所有配置从数据库读取
2. 移除配置文件中的 Archery 配置
3. 通过 Web 界面管理所有中间件

## 扩展其他中间件示例

### 添加 JumpServer 支持

```go
// 1. 在 models/middleware_datasource.go 中已预定义常量
const MiddlewareTypeJumpServer = "jumpserver"

// 2. 创建 JumpServer 数据源
authConfig := map[string]interface{}{
    "token": "your-jumpserver-token",
}

settings := map[string]interface{}{
    "api_version":    "v2",
    "asset_group_id": "default",
    "protocol":       "ssh",
    "port":           22,
}

ds := &models.MiddlewareDatasource{
    Name:           "jumpserver-prod",
    Type:           models.MiddlewareTypeJumpServer,
    Address:        "https://jumpserver.example.com",
    AuthType:       models.AuthTypeToken,
    AuthConfigJson: authConfig,
    SettingsJson:   settings,
    // ... 其他字段
}
```

### 添加 Jenkins 支持

```go
// Basic Auth 认证
authConfig := map[string]interface{}{
    "username": "admin",
    "password": "your-password",
}

settings := map[string]interface{}{
    "api_version":    "2.0",
    "crumb_required": true,
    "job_base_path":  "/job",
}

ds := &models.MiddlewareDatasource{
    Name:           "jenkins-prod",
    Type:           models.MiddlewareTypeJenkins,
    Address:        "https://jenkins.example.com",
    AuthType:       models.AuthTypeBasic,
    AuthConfigJson: authConfig,
    SettingsJson:   settings,
    // ... 其他字段
}
```

## 安全注意事项

1. **敏感信息加密**
   - 所有包含密码、Token 的配置必须加密存储
   - 使用 `Encrypt()` 方法加密后再保存
   - 使用 `Decrypt()` 方法读取时解密

2. **权限控制**
   - 中间件数据源管理应限制为 Admin 角色
   - API 接口需添加权限检查中间件

3. **审计日志**
   - 记录所有创建、修改、删除操作
   - 记录操作人和操作时间

## 测试清单

- [ ] 数据库迁移测试 (MySQL/PostgreSQL/SQLite)
- [ ] Archery 配置迁移测试
- [ ] CRUD 操作测试
- [ ] 加密/解密测试
- [ ] 健康检查测试
- [ ] 并发读写测试
- [ ] 前端表单验证测试
- [ ] API 接口测试

## 文档更新

需要更新以下文档:
- [ ] API 接口文档
- [ ] 数据库设计文档
- [ ] 用户使用手册
- [ ] 开发者指南

## 总结

本次实现完成了中间件数据源的核心数据库设计和模型层代码,提供了完整的:
- ✅ 灵活的数据库表结构
- ✅ 完善的 Go 模型定义
- ✅ 完整的 CRUD 方法
- ✅ 加密/解密支持
- ✅ Archery 配置迁移支持
- ✅ 扩展性设计 (易于添加新中间件)

下一步需要完成 API 层、服务层改造和前端开发,即可实现完整的中间件数据源管理功能。
