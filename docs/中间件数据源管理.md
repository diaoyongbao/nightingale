# 中间件数据源管理系统

## 概述

中间件数据源管理系统用于统一管理各种运维中间件（如 JumpServer、Jenkins、GitLab、Nacos、Consul 等）的连接配置。

> **注意**：此模块与 DBM（数据库管理）模块独立，DBM 模块使用 `db_instance` 表直接管理数据库连接。

## 核心特性

- ✅ **统一管理** - 所有中间件配置集中存储在数据库中
- ✅ **动态配置** - 支持运行时增删改查，无需重启服务
- ✅ **多实例支持** - 可配置同一类型的多个中间件实例
- ✅ **多种认证** - 支持 Token、Basic Auth、Session、OAuth2 等认证方式
- ✅ **加密存储** - 敏感信息（密码、Token）使用 RSA 加密
- ✅ **健康检查** - 内置健康检查机制，实时监控中间件状态

## 支持的中间件类型

| 类型        | 常量                          | 说明         | 推荐认证方式    |
|-------------|------------------------------|--------------|----------------|
| JumpServer  | `MiddlewareTypeJumpServer`   | 堡垒机       | Token          |
| Jenkins     | `MiddlewareTypeJenkins`      | CI/CD        | Basic / Token  |
| GitLab      | `MiddlewareTypeGitLab`       | 代码仓库     | Token          |
| Nacos       | `MiddlewareTypeNacos`        | 配置中心     | Basic          |
| Consul      | `MiddlewareTypeConsul`       | 服务发现     | Token          |

## 认证方式

| 方式       | 常量             | 配置示例                                            |
|------------|------------------|-----------------------------------------------------|
| Token      | `AuthTypeToken`  | `{"token": "xxx", "header_name": "Authorization"}`  |
| Basic Auth | `AuthTypeBasic`  | `{"username": "admin", "password": "xxx"}`          |
| Session    | `AuthTypeSession`| `{"username": "admin", "password": "xxx", "login_url": "/login"}` |
| OAuth2     | `AuthTypeOAuth2` | `{"client_id": "xxx", "client_secret": "xxx"}`      |
| None       | `AuthTypeNone`   | `{}`                                                 |

## 数据库表结构

### middleware_datasource 表

```sql
CREATE TABLE `middleware_datasource` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(191) UNIQUE NOT NULL COMMENT '数据源名称',
  `type` varchar(64) NOT NULL COMMENT '中间件类型',
  `description` varchar(500) COMMENT '描述',
  `address` varchar(500) NOT NULL COMMENT '中间件地址',
  `status` varchar(32) DEFAULT 'enabled' COMMENT '状态',
  
  -- 连接配置
  `timeout` int DEFAULT 5000 COMMENT '请求超时(毫秒)',
  `connect_timeout` int DEFAULT 2000 COMMENT '连接超时(毫秒)',
  `insecure_skip_verify` tinyint(1) DEFAULT 0 COMMENT '跳过SSL验证',
  
  -- 认证配置
  `auth_type` varchar(32) NOT NULL COMMENT '认证类型',
  `auth_config` text COMMENT '认证配置JSON',
  `auth_config_encoded` text COMMENT '加密后的认证配置',
  
  -- 扩展配置
  `settings` text COMMENT '扩展配置JSON',
  `settings_encoded` text COMMENT '加密后的扩展配置',
  
  -- 健康检查
  `health_check_url` varchar(500) COMMENT '健康检查URL',
  `health_check_interval` int DEFAULT 60 COMMENT '检查间隔(秒)',
  `last_health_check` bigint DEFAULT 0,
  `health_status` varchar(32) DEFAULT 'unknown',
  `health_message` varchar(500),
  
  -- 元信息
  `tags` varchar(500),
  `order_num` int DEFAULT 0,
  `created_at` bigint NOT NULL,
  `created_by` varchar(64) NOT NULL,
  `updated_at` bigint NOT NULL,
  `updated_by` varchar(64) NOT NULL,
  
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## API 接口

| 方法   | 路径                                              | 说明             |
|--------|---------------------------------------------------|------------------|
| GET    | `/api/n9e/middleware-datasources`                 | 获取列表(支持筛选) |
| GET    | `/api/n9e/middleware-datasources/count`           | 获取数量         |
| GET    | `/api/n9e/middleware-datasource/:id`              | 获取详情         |
| POST   | `/api/n9e/middleware-datasource`                  | 创建             |
| PUT    | `/api/n9e/middleware-datasource/:id`              | 更新             |
| DELETE | `/api/n9e/middleware-datasources`                 | 批量删除         |
| POST   | `/api/n9e/middleware-datasource/:id/test`         | 测试连接         |
| GET    | `/api/n9e/middleware-datasource/types`            | 获取类型列表     |
| GET    | `/api/n9e/middleware-datasource/by-type`          | 按类型获取       |
| POST   | `/api/n9e/middleware-datasources/status`          | 批量更新状态     |
| GET    | `/api/n9e/middleware-datasource/:id/export`       | 导出配置         |

## 文件结构

### 后端文件

```
nightingale/
├── models/
│   ├── middleware_datasource.go          # 核心模型（CRUD、加密解密）
│   ├── middleware_datasource_migrate.go  # 迁移辅助函数
│   └── migrate/
│       └── migrate_middleware_datasource.go  # 数据库迁移
├── center/
│   ├── router/
│   │   ├── router_middleware_datasource.go   # API 路由
│   │   └── router_middleware_helper.go       # 辅助函数
│   └── cron/
│       └── middleware_health_check.go        # 健康检查定时任务
```

### 前端文件

```
fe/src/
├── pages/middleware/
│   ├── index.tsx              # 列表页
│   ├── Form.tsx               # 创建/编辑表单
│   └── locale/                # 国际化
├── services/
│   └── middleware.ts          # API 服务
```

## 使用示例

### 创建 JumpServer 数据源

```go
ds := &models.MiddlewareDatasource{
    Name:        "jumpserver-prod",
    Type:        models.MiddlewareTypeJumpServer,
    Description: "生产环境堡垒机",
    Address:     "https://jumpserver.example.com",
    Status:      models.MiddlewareStatusEnabled,
    AuthType:    models.AuthTypeToken,
    AuthConfigJson: map[string]interface{}{
        "token":       "your-api-token",
        "header_name": "Authorization",
    },
    HealthCheckUrl:      "/api/health/",
    HealthCheckInterval: 60,
}
err := ds.Add(ctx)
```

### 查询所有启用的 Jenkins 实例

```go
list, err := models.GetEnabledMiddlewareDatasourcesByType(ctx, models.MiddlewareTypeJenkins)
```

## 权限配置

- **权限点**: `/system/middleware`
- **角色要求**: Admin Only
- **菜单位置**: 集成中心 → 中间件数据源

## 扩展新中间件类型

1. 在 `models/middleware_datasource.go` 添加类型常量
2. 在前端 `locale/*.ts` 添加对应翻译
3. （可选）在 `cron/middleware_health_check.go` 添加健康检查逻辑

---

**版本**: 1.0.0  
**更新日期**: 2026-01-07
