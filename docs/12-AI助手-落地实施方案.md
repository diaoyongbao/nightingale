# AI助手 - 架构落地与实施方案 (Implementation Plan)

> **文档目的**: 结合 `10-AI助手-Agent架构与工具调用分析.md` 的现状诊断与 `11-AI助手-动态Agent架构与系统集成设计.md` 的未来规划，制定具体的架构融合方案与分阶段实施路径。

---

## 1. 核心架构演进

我们不再区分“当前架构”和“理想架构”，而是定义一个**统一的目标架构**，将“文档10”中的硬编码组件逐步替换为“文档11”中的动态组件。

### 1.1 总体架构图

```mermaid
graph TD
    Request[用户请求: "Chat Request"] --> Handler[Chat Handler]
    
    subgraph "Router Engine (动态路由引擎)"
        Handler --> L0{L0: Mentions?}
        L0 -- Yes --> Direct[加载指定 Agent]
        L0 -- No --> L1{L1: Vector Search}
        L1 -- Top 5 Agents --> L2[L2: LLM Decision]
        L2 -- "选定 Agent" --> Loader[Agent Loader]
    end
    
    subgraph "Agent Executive (执行上下文)"
        Loader -- "Load Config" --> Context[Agent Context]
        Context --> Prompt[System Prompt]
        Context --> Toolset[Tool Definitions]
        
        Prompt --> LLM[LLM Chat Deployment]
        Toolset --> LLM
    end
    
    subgraph "Universal Tool System (通用工具系统)"
        LLM -- "Function Call" --> Dispatcher[Tool Dispatcher]
        
        Dispatcher --> Native[Native Handlers (Go Code)]
        Dispatcher --> Dynamic[API Adapter (Dynamic)]
        Dispatcher --> MCP[MCP Client (External)]
    end
```

---

## 2. 详细设计与融合方案

### 2.1 数据模型层 (Schema Migration)
**现状**: Agent/Tool 定义在代码中 (`experts.go`, `registry.go`)。
**目标**: Agent/Tool 统一定义在数据库中 (`ai_agent`, `ai_tool`)。

**Schema 设计**:
1.  **AI_AGENT**: 
    - **统一纳管**: 无论是业务 Agent (如 K8sExpert) 还是 **系统 Agent (System Agents)** 均在此表中管理。
    - **系统级保留名称**:
        - `sys_router`: 负责 L2 路由决策 (Prompt: "你是一个分发员...")。
        - `sys_summary`: 负责工具结果汇总 (Prompt: "根据工具返回结果回答...")。
        - `sys_knowledge`: 知识库专家。
    - **配置化能力**: 管理员可在前端修改 `sys_summary` 的 Prompt 来调整回答语气，或单独为 `sys_router` 配置更廉价的 Model。
    - **Seed Data**: 系统启动时若未发现这些 Agent，自动初始化默认配置。
2.  **AI_TOOL**: 
    - 迁移 `knowledge/registry.go` 中的知识库工具。
    - 新增 DBM, Alert 的 API 映射配置。
    - 字段 `implementation_type`: `native` (Go代码), `api` (HTTP配置), `mcp` (外部)。

### 2.2 路由层 (Routing Layer)
**现状**: `Coordinator` 仅支持简单的关键词匹配，大部分逻辑未启用。
**目标**: 实现三层路由。

**实施方案**:
1.  **改造 `CoordinatorAgent`**:
    - 移除硬编码的 `fastRoute`。
    - 注入 `AgentLoader` (interface)。
    - 实现 `Route(ctx, query string) (*AgentConfig, error)` 接口。
2.  **实现 `MentionMiddleware`**:
    - 在进入 LLM 之前解析 `@AgentName`。
3.  **实现 `LLMRouter`**:
    - 一个轻量级的 Prompt 模板，输入是候选 Agent 列表，输出是 Target Agent ID。

### 2.3 工具执行层 (Execution Layer)
**现状**: `handleWithFunctionCalling` 直接调用知识库，其他工具未通。
**目标**: 统一的 `ToolDispatcher`。

**实施方案**:
1.  **统一接口**:
    ```go
    type ToolExecutor interface {
        Execute(ctx context.Context, args map[string]interface{}) (interface{}, error)
    }
    ```
2.  **分发逻辑**:
    - `Dispatcher` 根据 `ai_tool.implementation_type` 路由：
        - `native` -> 查找已注册的 Go Handler (如 DBM SQL Check)。
        - `api` -> 调用 `GenericRequestExecutor` (构造 HTTP 请求)。
        - `mcp` -> 调用 `MCPManager`。

---

## 3. 分阶段实施路径 (Phased Rollout)

为了平滑过渡，不破坏现有功能，建议按以下阶段进行。

### Phase 1: 基础建设与数据化 (预计 1 周)
**目标**: 将现有硬编码 Agent 转为数据库配置，跑通基础流程。

1.  **Database**: 创建 `ai_agent`, `ai_tool`, `ai_tool_rel` 表。
2.  **Seed Data**: 编写脚本，将 `experts.go` 中的 K8s/DB/Alert 专家写入数据库。
3.  **Loader**: 实现 `AgentRepository`，支持从 DB 加载 Agent 配置。
4.  **Refactor**: 修改 `ChatHandler`，不再直接 new `Coordinator`，而是通过 `AgentLoader` 获取 Agent。
    - *此时仍使用关键词路由，但数据源变了。*

### Phase 2: 工具系统升级 (预计 1-2 周)
**目标**: 让 Agent 真正能干活（执行 API）。

1.  **API Adapter**: 实现 `GenericAPIToolExecutor`，支持配置化调用内部 API。
2.  **Tool Registry**: 将 DBM (SQL Check) 和 Alert (Mute Preview) 注册为 `native` 工具，或配置为 `api` 工具。
3.  **Validation**: 测试 "DB专家" 调用 "SQL Check" 工具的完整链路。

### Phase 3: 智能路由与交互优化 (预计 1-2 周)
**目标**: 支持 @Mention 和 LLM 路由，提升体验。

1.  **Mentions**: 前端支持 `@` 联想，后端 `Coordinator` 支持解析 `@` 前缀。
2.  **LLM Router**: 实现 L2 级路由 Prompt，替代关键词匹配。
    - *暂不实现 L1 向量检索，先用全量 Agent 列表进行 LLM 路由（数量 < 20 时可行）。*

### Phase 4: 大规模扩展 (长期规划)
**目标**: 支持 50+ Agent 和 外部 MCP。

1.  **Vector DB**: 引入简单的向量检索（如 pgvector 或内存 embedding 库），实现 L1 召回。
2.  **MCP Integration**: 完善 MCP Client，支持连接 K8s 的 MCP Server。

---

## 4. 关键代码变更点

| 模块 | 文件路径 | 变更内容 |
|------|----------|----------|
| **Models** | `models/ai_agent.go` | 新增 Agent/Tool 实体定义 |
| **Logic** | `center/aiassistant/agent/loader.go` | 实现数据库加载逻辑 |
| **Logic** | `center/aiassistant/agent/router.go` | 实现 Mention 解析和 LLM 决策逻辑 |
| **Engine** | `center/aiassistant/executor/dispatcher.go` | 实现统一工具分发 (Native/API/MCP) |
| **Engine** | `center/aiassistant/executor/api_adapter.go` | 实现通用 API 调用逻辑 |
| **Config** | `sql/n9e_v6.sql` | SQL Migration 脚本 |

---

## 5. 常见问题预案

**Q: 现有的知识库功能会受影响吗？**
A: 不会。知识库将被迁移为一个名为 `KnowledgeExpert` 的标准 Agent，拥有 `search` 工具。路由逻辑会自然地将其视为候选者之一。

**Q: Token 消耗如何控制？**
A: 在 Phase 3 之前，Agent 数量较少，不会有明显问题。Phase 4 引入向量召回后，Token 消耗将恒定在 Top-5 Agent 的范围内。

**Q: API 调用安全吗？**
A: `GenericAPIToolExecutor` 将复用内部调用的鉴权机制，且所有写操作（POST/PUT/DELETE）仍需经过 `RiskChecker` (现有的二次确认机制) 审核。
