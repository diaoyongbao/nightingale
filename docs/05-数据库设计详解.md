# 夜莺监控数据库设计详解

## 1. 数据库概览

### 1.1 支持的数据库

- **MySQL** 5.7+ (推荐)
- **PostgreSQL** 9.6+
- **SQLite** (开发测试用)

### 1.2 字符集

- 字符集: `utf8mb4`
- 排序规则: `utf8mb4_unicode_ci`

### 1.3 表分类

```
核心业务表 (20+)
├── 用户权限类 (5张)
│   ├── user (用户)
│   ├── user_group (用户组)
│   ├── user_group_member (用户组成员)
│   ├── role (角色)
│   └── role_operation (角色操作权限)
├── 业务组织类 (3张)
│   ├── busi_group (业务组)
│   ├── busi_group_member (业务组成员)
│   └── target_busi_group (监控对象业务组关联)
├── 告警规则类 (6张)
│   ├── alert_rule (告警规则)
│   ├── alert_mute (告警屏蔽)
│   ├── alert_subscribe (告警订阅)
│   ├── alert_cur_event (当前告警事件)
│   ├── alert_his_event (历史告警事件)
│   └── alert_aggr_view (告警聚合视图)
├── 通知管理类 (5张)
│   ├── notify_rule (通知规则)
│   ├── notify_channel (通知渠道)
│   ├── message_template (消息模板)
│   ├── notification_record (通知记录)
│   └── event_pipeline (事件管道)
├── 监控对象类 (2张)
│   ├── target (监控对象)
│   └── host_meta (主机元数据)
├── 数据源类 (2张)
│   ├── datasource (数据源)
│   └── es_index_pattern (ES索引模式)
├── 仪表盘类 (4张)
│   ├── dashboard (仪表盘)
│   ├── board (看板)
│   ├── board_payload (看板配置)
│   └── chart_share (图表分享)
└── 其他 (10+张)
    ├── configs (配置)
    ├── recording_rule (记录规则)
    ├── task_tpl (任务模板)
    ├── task_record (任务记录)
    ├── metric_view (指标视图)
    ├── builtin_components (内置组件)
    ├── builtin_payloads (内置配置)
    ├── saved_view (保存的视图)
    └── ...
```

## 2. 核心表结构

### 2.1 用户权限表

#### 2.1.1 user (用户表)

```sql
CREATE TABLE `user` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `username` varchar(64) NOT NULL COMMENT '用户名',
  `nickname` varchar(64) NOT NULL DEFAULT '' COMMENT '昵称',
  `password` varchar(128) NOT NULL DEFAULT '' COMMENT '密码(bcrypt加密)',
  `phone` varchar(16) NOT NULL DEFAULT '' COMMENT '手机号',
  `email` varchar(64) NOT NULL DEFAULT '' COMMENT '邮箱',
  `portrait` varchar(255) NOT NULL DEFAULT '' COMMENT '头像URL',
  `roles` varchar(255) NOT NULL DEFAULT '' COMMENT '角色(逗号分隔)',
  `contacts` text COMMENT '联系方式(JSON)',
  `maintainer` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否运维人员',
  `create_at` bigint NOT NULL DEFAULT 0 COMMENT '创建时间',
  `create_by` varchar(64) NOT NULL DEFAULT '' COMMENT '创建人',
  `update_at` bigint NOT NULL DEFAULT 0 COMMENT '更新时间',
  `update_by` varchar(64) NOT NULL DEFAULT '' COMMENT '更新人',
  `admin` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否管理员',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_username` (`username`),
  KEY `idx_phone` (`phone`),
  KEY `idx_email` (`email`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户表';
```

**字段说明**:
- `username`: 登录用户名,唯一
- `password`: bcrypt加密的密码
- `roles`: 角色列表,如 "Admin,Standard"
- `contacts`: JSON格式的联系方式,如 `{"dingtalk":"xxx","wecom":"xxx"}`
- `admin`: 是否系统管理员

#### 2.1.2 user_group (用户组表)

```sql
CREATE TABLE `user_group` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(128) NOT NULL DEFAULT '' COMMENT '组名',
  `note` varchar(255) NOT NULL DEFAULT '' COMMENT '备注',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`),
  KEY `idx_update_at` (`update_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户组表';
```

#### 2.1.3 user_group_member (用户组成员表)

```sql
CREATE TABLE `user_group_member` (
  `group_id` bigint unsigned NOT NULL COMMENT '用户组ID',
  `user_id` bigint unsigned NOT NULL COMMENT '用户ID',
  PRIMARY KEY (`group_id`, `user_id`),
  KEY `idx_user_id` (`user_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='用户组成员表';
```

### 2.2 业务组织表

#### 2.2.1 busi_group (业务组表)

```sql
CREATE TABLE `busi_group` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(191) NOT NULL COMMENT '业务组名称',
  `label_enable` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否启用标签',
  `label_value` varchar(191) NOT NULL DEFAULT '' COMMENT '标签值',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_name` (`name`),
  KEY `idx_update_at` (`update_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='业务组表';
```

**字段说明**:
- `label_enable`: 是否启用标签模式
- `label_value`: 标签值,用于自动关联监控对象

#### 2.2.2 busi_group_member (业务组成员表)

```sql
CREATE TABLE `busi_group_member` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `busi_group_id` bigint unsigned NOT NULL COMMENT '业务组ID',
  `user_group_id` bigint unsigned NOT NULL COMMENT '用户组ID',
  `perm_flag` char(2) NOT NULL DEFAULT '' COMMENT '权限标识: ro(只读) rw(读写)',
  PRIMARY KEY (`id`),
  KEY `idx_busi_group_id` (`busi_group_id`),
  KEY `idx_user_group_id` (`user_group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='业务组成员表';
```

### 2.3 告警规则表

#### 2.3.1 alert_rule (告警规则表)

```sql
CREATE TABLE `alert_rule` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `group_id` bigint NOT NULL DEFAULT 0 COMMENT '业务组ID',
  `cate` varchar(128) NOT NULL DEFAULT '' COMMENT '规则类型: prometheus/elasticsearch/loki等',
  `datasource_ids` varchar(255) NOT NULL DEFAULT '' COMMENT '数据源ID列表(已废弃)',
  `datasource_queries` text COMMENT '数据源查询配置(JSON)',
  `cluster` varchar(128) NOT NULL DEFAULT '' COMMENT '集群(已废弃)',
  `name` varchar(255) NOT NULL COMMENT '规则名称',
  `note` text COMMENT '备注',
  `prod` varchar(255) NOT NULL DEFAULT '' COMMENT '产品标识',
  `algorithm` varchar(255) NOT NULL DEFAULT '' COMMENT '算法',
  `algo_params` varchar(255) DEFAULT '' COMMENT '算法参数',
  `delay` int NOT NULL DEFAULT 0 COMMENT '延迟评估时间(秒)',
  `severity` tinyint(1) NOT NULL DEFAULT 1 COMMENT '告警级别: 1紧急 2警告 3提示',
  `disabled` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否禁用: 0启用 1禁用',
  `prom_for_duration` int NOT NULL DEFAULT 0 COMMENT 'Prometheus for持续时间(已废弃)',
  `prom_ql` text COMMENT 'PromQL查询语句',
  `rule_config` text COMMENT '规则配置(JSON)',
  `prom_eval_interval` int NOT NULL DEFAULT 0 COMMENT '评估间隔(秒)',
  `enable_stime` varchar(255) NOT NULL DEFAULT '00:00' COMMENT '生效开始时间(已废弃)',
  `enable_etime` varchar(255) NOT NULL DEFAULT '23:59' COMMENT '生效结束时间(已废弃)',
  `enable_days_of_week` varchar(255) NOT NULL DEFAULT '' COMMENT '生效星期(已废弃)',
  `enable_in_bg` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否仅在业务组内生效',
  `notify_recovered` tinyint(1) NOT NULL DEFAULT 1 COMMENT '是否发送恢复通知',
  `notify_channels` varchar(255) NOT NULL DEFAULT '' COMMENT '通知渠道(已废弃)',
  `notify_groups` varchar(255) NOT NULL DEFAULT '' COMMENT '通知组(已废弃)',
  `notify_repeat_step` int NOT NULL DEFAULT 0 COMMENT '重复通知间隔(分钟)',
  `notify_max_number` int NOT NULL DEFAULT 0 COMMENT '最大通知次数',
  `recover_duration` bigint NOT NULL DEFAULT 0 COMMENT '恢复持续时间(秒)',
  `callbacks` text COMMENT '回调地址(已废弃)',
  `runbook_url` varchar(255) DEFAULT '' COMMENT 'Runbook URL',
  `append_tags` varchar(255) NOT NULL DEFAULT '' COMMENT '附加标签',
  `annotations` text COMMENT '注解(JSON)',
  `extra_config` text COMMENT '扩展配置(JSON)',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  `cron_pattern` varchar(255) NOT NULL DEFAULT '' COMMENT 'Cron表达式',
  `notify_rule_ids` json DEFAULT NULL COMMENT '通知规则ID列表',
  `pipeline_configs` json DEFAULT NULL COMMENT '事件管道配置',
  `notify_version` int NOT NULL DEFAULT 0 COMMENT '通知版本: 0旧版 1新版',
  PRIMARY KEY (`id`),
  KEY `idx_group_id` (`group_id`),
  KEY `idx_update_at` (`update_at`),
  KEY `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='告警规则表';
```

**重要字段说明**:
- `datasource_queries`: 新版数据源查询配置,支持复杂查询
- `rule_config`: 规则配置,包含查询、触发条件等
- `cron_pattern`: Cron表达式,用于定时评估
- `notify_rule_ids`: 新版通知规则ID列表
- `pipeline_configs`: 事件管道配置
- `notify_version`: 0表示使用旧版通知(notify_channels/notify_groups), 1表示使用新版通知(notify_rule_ids)

#### 2.3.2 alert_cur_event (当前告警事件表)

```sql
CREATE TABLE `alert_cur_event` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `cate` varchar(128) NOT NULL DEFAULT '' COMMENT '规则类型',
  `datasource_id` bigint NOT NULL DEFAULT 0 COMMENT '数据源ID',
  `cluster` varchar(128) NOT NULL DEFAULT '' COMMENT '集群',
  `group_id` bigint unsigned NOT NULL COMMENT '业务组ID',
  `group_name` varchar(255) NOT NULL DEFAULT '' COMMENT '业务组名称',
  `hash` varchar(64) NOT NULL COMMENT '事件哈希值',
  `rule_id` bigint unsigned NOT NULL COMMENT '规则ID',
  `rule_name` varchar(255) NOT NULL COMMENT '规则名称',
  `rule_note` varchar(512) NOT NULL DEFAULT '' COMMENT '规则备注',
  `rule_prod` varchar(255) NOT NULL DEFAULT '' COMMENT '规则产品',
  `rule_algo` varchar(255) NOT NULL DEFAULT '' COMMENT '规则算法',
  `severity` tinyint(1) NOT NULL COMMENT '告警级别',
  `prom_for_duration` int NOT NULL COMMENT 'for持续时间',
  `prom_ql` text NOT NULL COMMENT 'PromQL',
  `prom_eval_interval` int NOT NULL COMMENT '评估间隔',
  `callbacks` text NOT NULL COMMENT '回调地址',
  `runbook_url` varchar(255) DEFAULT '' COMMENT 'Runbook URL',
  `notify_recovered` tinyint(1) NOT NULL COMMENT '是否通知恢复',
  `notify_channels` varchar(255) NOT NULL DEFAULT '' COMMENT '通知渠道',
  `notify_groups` varchar(255) NOT NULL DEFAULT '' COMMENT '通知组',
  `notify_rule_ids` json DEFAULT NULL COMMENT '通知规则ID',
  `notify_cur_number` int NOT NULL DEFAULT 0 COMMENT '当前通知次数',
  `target_ident` varchar(191) NOT NULL DEFAULT '' COMMENT '监控对象标识',
  `target_note` varchar(191) NOT NULL DEFAULT '' COMMENT '监控对象备注',
  `first_trigger_time` bigint DEFAULT NULL COMMENT '首次触发时间',
  `trigger_time` bigint NOT NULL COMMENT '触发时间',
  `trigger_value` varchar(255) NOT NULL COMMENT '触发值',
  `annotations` text COMMENT '注解',
  `tags` varchar(1024) NOT NULL DEFAULT '' COMMENT '标签',
  `status` int NOT NULL DEFAULT 0 COMMENT '状态: 0触发 1恢复',
  `claimant` varchar(64) NOT NULL DEFAULT '' COMMENT '认领人',
  `last_eval_time` bigint NOT NULL DEFAULT 0 COMMENT '最后评估时间',
  `last_sent_time` bigint NOT NULL DEFAULT 0 COMMENT '最后发送时间',
  `notify_version` int NOT NULL DEFAULT 0 COMMENT '通知版本',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_hash` (`hash`),
  KEY `idx_rule_id` (`rule_id`),
  KEY `idx_trigger_time` (`trigger_time`),
  KEY `idx_group_id` (`group_id`),
  KEY `idx_target_ident` (`target_ident`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='当前告警事件表';
```

**字段说明**:
- `hash`: 事件唯一标识,用于去重
- `status`: 0表示触发中, 1表示已恢复
- `notify_cur_number`: 当前已发送通知次数
- `claimant`: 认领该告警的用户

#### 2.3.3 alert_his_event (历史告警事件表)

```sql
CREATE TABLE `alert_his_event` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `is_recovered` tinyint(1) NOT NULL COMMENT '是否已恢复',
  `cate` varchar(128) NOT NULL DEFAULT '',
  `datasource_id` bigint NOT NULL DEFAULT 0,
  `cluster` varchar(128) NOT NULL DEFAULT '',
  `group_id` bigint unsigned NOT NULL,
  `group_name` varchar(255) NOT NULL DEFAULT '',
  `hash` varchar(64) NOT NULL,
  `rule_id` bigint unsigned NOT NULL,
  `rule_name` varchar(255) NOT NULL,
  `rule_note` varchar(512) NOT NULL DEFAULT '',
  `rule_prod` varchar(255) NOT NULL DEFAULT '',
  `rule_algo` varchar(255) NOT NULL DEFAULT '',
  `severity` tinyint(1) NOT NULL,
  `prom_for_duration` int NOT NULL,
  `prom_ql` text NOT NULL,
  `prom_eval_interval` int NOT NULL,
  `callbacks` text NOT NULL,
  `runbook_url` varchar(255) DEFAULT '',
  `notify_recovered` tinyint(1) NOT NULL,
  `notify_channels` varchar(255) NOT NULL DEFAULT '',
  `notify_groups` varchar(255) NOT NULL DEFAULT '',
  `notify_rule_ids` json DEFAULT NULL,
  `notify_cur_number` int NOT NULL DEFAULT 0,
  `target_ident` varchar(191) NOT NULL DEFAULT '',
  `target_note` varchar(191) NOT NULL DEFAULT '',
  `first_trigger_time` bigint DEFAULT NULL,
  `trigger_time` bigint NOT NULL,
  `trigger_value` varchar(255) NOT NULL,
  `annotations` text,
  `tags` varchar(1024) NOT NULL DEFAULT '',
  `recover_time` bigint NOT NULL DEFAULT 0 COMMENT '恢复时间',
  `last_eval_time` bigint NOT NULL DEFAULT 0,
  `last_sent_time` bigint NOT NULL DEFAULT 0,
  `notify_version` int NOT NULL DEFAULT 0,
  PRIMARY KEY (`id`),
  KEY `idx_hash` (`hash`),
  KEY `idx_rule_id` (`rule_id`),
  KEY `idx_trigger_time` (`trigger_time`),
  KEY `idx_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='历史告警事件表';
```

### 2.4 通知管理表

#### 2.4.1 notify_rule (通知规则表)

```sql
CREATE TABLE `notify_rule` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL COMMENT '规则名称',
  `disabled` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否禁用',
  `user_group_ids` json NOT NULL COMMENT '用户组ID列表',
  `channel_ids` json NOT NULL COMMENT '通知渠道ID列表',
  `contact_keys` json NOT NULL COMMENT '联系方式key列表',
  `match_conditions` json NOT NULL COMMENT '匹配条件',
  `for_duration` int NOT NULL DEFAULT 0 COMMENT '持续时间(秒)',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知规则表';
```

**字段说明**:
- `user_group_ids`: 接收通知的用户组ID列表
- `channel_ids`: 使用的通知渠道ID列表
- `contact_keys`: 联系方式key,如 ["phone","email","dingtalk"]
- `match_conditions`: 匹配条件,JSON格式,支持标签匹配、级别匹配等

#### 2.4.2 notify_channel (通知渠道表)

```sql
CREATE TABLE `notify_channel` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL COMMENT '渠道名称',
  `ident` varchar(255) NOT NULL COMMENT '渠道标识',
  `built_in` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否内置',
  `hide` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否隐藏',
  `account_id` bigint NOT NULL DEFAULT 0 COMMENT '账号ID',
  `extra_config` text COMMENT '扩展配置(JSON)',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_ident` (`ident`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='通知渠道表';
```

**字段说明**:
- `ident`: 渠道唯一标识,如 "dingtalk-robot-1"
- `built_in`: 是否系统内置渠道
- `extra_config`: 渠道配置,如钉钉机器人的webhook地址

#### 2.4.3 message_template (消息模板表)

```sql
CREATE TABLE `message_template` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(255) NOT NULL COMMENT '模板名称',
  `channel_ident` varchar(255) NOT NULL COMMENT '渠道标识',
  `content` text NOT NULL COMMENT '模板内容',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `idx_channel_ident` (`channel_ident`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='消息模板表';
```

### 2.5 监控对象表

#### 2.5.1 target (监控对象表)

```sql
CREATE TABLE `target` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `ident` varchar(191) NOT NULL COMMENT '唯一标识',
  `note` varchar(255) NOT NULL DEFAULT '' COMMENT '备注',
  `tags` text NOT NULL COMMENT '标签',
  `update_at` bigint NOT NULL DEFAULT 0 COMMENT '更新时间',
  `host_tags` text COMMENT '主机标签',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_ident` (`ident`),
  KEY `idx_update_at` (`update_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='监控对象表';
```

**字段说明**:
- `ident`: 监控对象唯一标识,通常是主机名或IP
- `tags`: 标签,格式如 "region=cn-north env=prod"
- `host_tags`: 主机标签,从采集器上报

#### 2.5.2 target_busi_group (监控对象业务组关联表)

```sql
CREATE TABLE `target_busi_group` (
  `target_ident` varchar(191) NOT NULL COMMENT '监控对象标识',
  `group_id` bigint NOT NULL COMMENT '业务组ID',
  PRIMARY KEY (`target_ident`, `group_id`),
  KEY `idx_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='监控对象业务组关联表';
```

### 2.6 数据源表

#### 2.6.1 datasource (数据源表)

```sql
CREATE TABLE `datasource` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `name` varchar(191) NOT NULL COMMENT '数据源名称',
  `description` varchar(255) NOT NULL DEFAULT '' COMMENT '描述',
  `category` varchar(255) NOT NULL DEFAULT '' COMMENT '分类',
  `plugin_id` int unsigned NOT NULL DEFAULT 0 COMMENT '插件ID',
  `plugin_type` varchar(255) NOT NULL DEFAULT '' COMMENT '插件类型',
  `plugin_type_name` varchar(255) NOT NULL DEFAULT '' COMMENT '插件类型名称',
  `cluster_name` varchar(255) NOT NULL DEFAULT '' COMMENT '集群名称',
  `settings` text COMMENT '配置(JSON)',
  `status` varchar(255) NOT NULL DEFAULT '' COMMENT '状态',
  `http` text COMMENT 'HTTP配置',
  `auth` text COMMENT '认证配置',
  `is_default` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否默认',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_name` (`name`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='数据源表';
```

**字段说明**:
- `plugin_type`: 数据源类型,如 prometheus, elasticsearch, loki
- `settings`: 数据源配置,JSON格式
- `is_default`: 是否默认数据源

### 2.7 仪表盘表

#### 2.7.1 dashboard (仪表盘表)

```sql
CREATE TABLE `dashboard` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `group_id` bigint NOT NULL DEFAULT 0 COMMENT '业务组ID',
  `name` varchar(255) NOT NULL COMMENT '仪表盘名称',
  `tags` varchar(255) NOT NULL DEFAULT '' COMMENT '标签',
  `configs` text COMMENT '配置(JSON)',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  PRIMARY KEY (`id`),
  KEY `idx_group_id` (`group_id`),
  KEY `idx_update_at` (`update_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='仪表盘表';
```

#### 2.7.2 board (看板表)

```sql
CREATE TABLE `board` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `group_id` bigint NOT NULL DEFAULT 0,
  `name` varchar(191) NOT NULL,
  `ident` varchar(200) NOT NULL DEFAULT '',
  `tags` varchar(255) NOT NULL DEFAULT '',
  `create_at` bigint NOT NULL DEFAULT 0,
  `create_by` varchar(64) NOT NULL DEFAULT '',
  `update_at` bigint NOT NULL DEFAULT 0,
  `update_by` varchar(64) NOT NULL DEFAULT '',
  `built_in` tinyint(1) NOT NULL DEFAULT 0,
  `hide` tinyint(1) NOT NULL DEFAULT 0,
  `public` tinyint(1) NOT NULL DEFAULT 0 COMMENT '是否公开',
  PRIMARY KEY (`id`),
  KEY `idx_group_id` (`group_id`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='看板表';
```

## 3. 索引设计

### 3.1 主键索引

所有表都使用自增ID作为主键

### 3.2 唯一索引

- `user.username`: 用户名唯一
- `busi_group.name`: 业务组名称唯一
- `datasource.name`: 数据源名称唯一
- `target.ident`: 监控对象标识唯一
- `alert_cur_event.hash`: 事件哈希唯一

### 3.3 普通索引

- 时间字段: `create_at`, `update_at`, `trigger_time`
- 关联字段: `group_id`, `rule_id`, `user_id`
- 查询字段: `name`, `ident`, `target_ident`

### 3.4 复合索引

```sql
-- 用户组成员表
PRIMARY KEY (`group_id`, `user_id`)
KEY `idx_user_id` (`user_id`)

-- 监控对象业务组关联表
PRIMARY KEY (`target_ident`, `group_id`)
KEY `idx_group_id` (`group_id`)
```

## 4. 数据迁移

### 4.1 初始化SQL

位于 `docker/initsql/a-n9e.sql`

### 4.2 自动迁移

使用GORM的AutoMigrate功能:

```go
// models/migrate/migrate.go
func Migrate(db *gorm.DB) {
    db.AutoMigrate(
        &models.User{},
        &models.UserGroup{},
        &models.BusiGroup{},
        &models.AlertRule{},
        &models.Target{},
        // ... 更多模型
    )
}
```

### 4.3 数据迁移

```go
// 业务组标签迁移
func MigrateBg(ctx *ctx.Context, labelKey string) {
    // 迁移逻辑
}

// 事件管道迁移
func MigrateEP(ctx *ctx.Context) {
    // 迁移逻辑
}
```

## 5. 查询优化

### 5.1 分页查询

```go
func AlertRuleGets(ctx *ctx.Context, groupId int64, limit, offset int) ([]*AlertRule, error) {
    var lst []*AlertRule
    err := DB(ctx).Where("group_id = ?", groupId).
        Order("id desc").
        Limit(limit).
        Offset(offset).
        Find(&lst).Error
    return lst, err
}
```

### 5.2 预加载

```go
func AlertRuleGetWithGroup(ctx *ctx.Context, id int64) (*AlertRule, error) {
    var rule AlertRule
    err := DB(ctx).Preload("BusiGroup").First(&rule, id).Error
    return &rule, err
}
```

### 5.3 批量操作

```go
func AlertRuleDels(ctx *ctx.Context, ids []int64) error {
    return DB(ctx).Where("id in ?", ids).Delete(&AlertRule{}).Error
}
```

## 6. 事务处理

```go
func (t *Target) Del(ctx *ctx.Context) error {
    return DB(ctx).Transaction(func(tx *gorm.DB) error {
        // 删除监控对象
        if err := tx.Delete(t).Error; err != nil {
            return err
        }
        
        // 删除业务组关联
        if err := tx.Where("target_ident = ?", t.Ident).
            Delete(&TargetBusiGroup{}).Error; err != nil {
            return err
        }
        
        return nil
    })
}
```

## 7. 配置表

### 7.1 configs (配置表)

```sql
CREATE TABLE `configs` (
  `id` bigint unsigned NOT NULL AUTO_INCREMENT,
  `ckey` varchar(191) NOT NULL COMMENT '配置key',
  `cval` text NOT NULL COMMENT '配置值',
  PRIMARY KEY (`id`),
  UNIQUE KEY `idx_ckey` (`ckey`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4 COMMENT='配置表';
```

**常用配置**:
- `site_info`: 站点信息
- `smtp`: 邮件配置
- `ibex`: 任务执行配置
- `notify_channels`: 通知渠道配置

### 7.2 配置读写

```go
// 读取配置
func ConfigsGet(ctx *ctx.Context, key string) (string, error) {
    var config Configs
    err := DB(ctx).Where("ckey = ?", key).First(&config).Error
    if err != nil {
        return "", err
    }
    return config.Cval, nil
}

// 写入配置
func ConfigsSet(ctx *ctx.Context, key, value string) error {
    return DB(ctx).Exec("INSERT INTO configs (ckey, cval) VALUES (?, ?) ON DUPLICATE KEY UPDATE cval = ?",
        key, value, value).Error
}
```

## 8. 数据备份与恢复

### 8.1 备份

```bash
# MySQL备份
mysqldump -u root -p n9e > n9e_backup.sql

# 只备份结构
mysqldump -u root -p --no-data n9e > n9e_schema.sql

# 只备份数据
mysqldump -u root -p --no-create-info n9e > n9e_data.sql
```

### 8.2 恢复

```bash
# 恢复数据库
mysql -u root -p n9e < n9e_backup.sql
```

## 9. 性能监控

### 9.1 慢查询日志

```sql
-- 开启慢查询日志
SET GLOBAL slow_query_log = 'ON';
SET GLOBAL long_query_time = 2;

-- 查看慢查询
SELECT * FROM mysql.slow_log;
```

### 9.2 表统计信息

```sql
-- 查看表大小
SELECT 
    table_name,
    table_rows,
    data_length,
    index_length,
    (data_length + index_length) as total_size
FROM information_schema.tables
WHERE table_schema = 'n9e'
ORDER BY total_size DESC;
```

## 10. 最佳实践

### 10.1 命名规范

- 表名: 小写下划线分隔
- 字段名: 小写下划线分隔
- 索引名: `idx_` 前缀

### 10.2 字段设计

- 使用合适的数据类型
- 避免NULL值
- 使用NOT NULL DEFAULT
- 合理使用TEXT和VARCHAR

### 10.3 索引设计

- 为常用查询字段添加索引
- 避免过多索引
- 定期分析索引使用情况
- 删除无用索引

### 10.4 查询优化

- 避免SELECT *
- 使用LIMIT限制结果集
- 使用预加载避免N+1查询
- 使用批量操作
