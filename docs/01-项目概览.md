# 夜莺监控(Nightingale)项目概览

## 1. 项目简介

夜莺 Nightingale 是一款开源云原生监控告警工具,是中国计算机学会(CCF)接受捐赠并托管的第一个开源项目。项目在 GitHub 上拥有超过 12000 颗星,广受关注和使用。

### 1.1 核心定位

- **告警引擎专家**:夜莺侧重于监控告警,类似于 Grafana 的数据源集成方式,但重点在告警引擎、告警事件的处理和分发
- **多数据源集成**:可以对接 Prometheus、Elasticsearch、ClickHouse、Loki、MySQL 等多种数据源
- **统一告警平台**:提供全面的告警判定、丰富的事件处理和灵活的告警分发及通知能力

### 1.2 项目起源

- 最初由滴滴开发和开源
- 2022年5月11日捐赠予中国计算机学会开源发展技术委员会(CCF ODTC)
- 为 CCF ODTC 成立后接受捐赠的第一个开源项目

## 2. 技术栈

### 2.1 后端技术栈

- **编程语言**: Go 1.24.0
- **Web框架**: Gin (v1.9.1)
- **数据库ORM**: GORM (v1.25.10)
- **支持的数据库**:
  - MySQL (主要)
  - PostgreSQL
  - SQLite
  - ClickHouse
- **缓存**: Redis (v9.0.2)
- **时序数据库对接**: 
  - Prometheus
  - VictoriaMetrics
  - TDEngine
- **日志数据源**:
  - Elasticsearch (v7)
  - OpenSearch (v2)
  - Loki
  - VictoriaLogs
- **消息队列**: Kafka (IBM/sarama v1.45.0)
- **认证授权**: 
  - JWT (golang-jwt/jwt v3.2.2)
  - OAuth2
  - CAS
  - LDAP (v3.4.4)
  - 钉钉
- **其他核心依赖**:
  - PromQL解析: VictoriaMetrics/metricsql
  - 表达式引擎: expr-lang/expr
  - 任务执行: flashcatcloud/ibex

### 2.2 前端技术栈

- **框架**: React 17.0.0
- **构建工具**: Vite 4.5.14
- **UI组件库**: Ant Design 4.21.0
- **路由**: React Router DOM 5.2.0
- **状态管理**: React Hooks Global State
- **图表库**:
  - @ant-design/plots (v1.0.9)
  - @antv/g2 (v5.4.7)
  - uplot (v1.6.31)
  - d3 (v4.10.0)
- **代码编辑器**:
  - @uiw/react-codemirror (4.6.0)
  - @fc-components/monaco-editor
  - @fc-components/codemirror-promql
- **国际化**: 
  - react-i18next (v14.0.0)
  - @tolgee/react (v6.2.7)
- **数据表格**:
  - ag-grid-react (v34.0.2)
  - react-data-grid (7.0.0-beta.16)
- **工具库**:
  - lodash (v4.17.21)
  - moment (v2.29.1)
  - axios (通过 umi-request v1.3.5)

### 2.3 开发工具

- **TypeScript**: 4.9.4
- **CSS预处理**: Less 4.1.1 + TailwindCSS 3.3.5
- **代码格式化**: Prettier 2.2.1
- **测试框架**: Jest 29.7.0

## 3. 项目结构

### 3.1 仓库组织

项目采用前后端分离架构,分为两个主要仓库:

1. **后端仓库**: `ccfos/nightingale`
2. **前端仓库**: `n9e/fe`

在本地开发环境中,两个仓库位于:
- 后端: `nightingale/`
- 前端: `fe/`

### 3.2 后端目录结构

```
nightingale/
├── cmd/                    # 各个可执行程序入口
│   ├── center/            # 中心服务(主服务)
│   ├── alert/             # 独立告警引擎
│   ├── edge/              # 边缘告警引擎
│   ├── pushgw/            # 数据推送网关
│   └── cli/               # 命令行工具
├── center/                # 中心服务核心逻辑
│   ├── router/            # HTTP路由定义
│   ├── cconf/             # 配置管理
│   ├── integration/       # 集成管理
│   ├── metas/             # 元数据管理
│   └── sso/               # 单点登录
├── alert/                 # 告警引擎
│   ├── eval/              # 告警规则评估
│   ├── dispatch/          # 告警分发
│   ├── process/           # 告警处理
│   ├── sender/            # 告警发送
│   ├── pipeline/          # 事件管道
│   └── naming/            # 命名规则
├── models/                # 数据模型
├── memsto/                # 内存缓存
├── storage/               # 存储层
├── datasource/            # 数据源适配
├── prom/                  # Prometheus客户端
├── pushgw/                # 推送网关
├── pkg/                   # 公共包
├── conf/                  # 配置结构
├── etc/                   # 配置文件示例
├── integrations/          # 内置集成
├── docker/                # Docker相关
└── front/                 # 前端静态资源嵌入
```

### 3.3 前端目录结构

```
fe/
├── src/
│   ├── pages/             # 页面组件
│   │   ├── alertRules/    # 告警规则
│   │   ├── alertCurEvent/ # 当前告警事件
│   │   ├── historyEvents/ # 历史告警事件
│   │   ├── dashboard/     # 仪表盘
│   │   ├── explorer/      # 数据探索
│   │   ├── targets/       # 监控对象
│   │   ├── user/          # 用户管理
│   │   ├── datasource/    # 数据源管理
│   │   ├── warning/       # 告警屏蔽/订阅
│   │   └── ...
│   ├── components/        # 公共组件
│   ├── services/          # API服务
│   ├── routers/           # 路由配置
│   ├── store/             # 状态管理
│   ├── utils/             # 工具函数
│   ├── locales/           # 国际化文件
│   └── plugins/           # 插件系统
├── public/                # 静态资源
├── plugins/               # 插件目录
└── package.json           # 依赖配置
```

## 4. 核心模块

### 4.1 后端核心模块

1. **Center (中心服务)**
   - 提供Web界面和API服务
   - 用户认证和权限管理
   - 配置管理
   - 数据源管理

2. **Alert (告警引擎)**
   - 告警规则评估
   - 告警事件生成
   - 告警分发和通知
   - 告警自愈

3. **PushGW (推送网关)**
   - 接收监控数据
   - 数据转发到时序库
   - 支持多种协议(Remote Write, OpenTSDB, Datadog等)

4. **Edge (边缘引擎)**
   - 边缘机房部署
   - 本地告警判定
   - 提升告警可用性

### 4.2 前端核心模块

1. **告警管理**
   - 告警规则配置
   - 告警事件查看
   - 告警屏蔽
   - 告警订阅

2. **数据探索**
   - 指标查询(Metric Explorer)
   - 日志查询(Log Explorer)
   - 链路追踪(Trace Explorer)

3. **仪表盘**
   - 可视化图表
   - 仪表盘管理
   - 图表分享

4. **监控对象**
   - 主机管理
   - 标签管理
   - 业务组关联

## 5. 部署架构

### 5.1 标准部署模式

```
┌─────────────┐
│   Categraf  │ (采集器)
└──────┬──────┘
       │ Remote Write
       ▼
┌─────────────┐
│ Nightingale │ (中心服务)
│   Center    │
└──────┬──────┘
       │
       ├─► MySQL/PostgreSQL (元数据)
       ├─► Redis (缓存)
       └─► Prometheus/VictoriaMetrics (时序数据)
```

### 5.2 边缘部署模式

```
┌──────────────────────────────────────┐
│         中心机房                      │
│  ┌─────────────┐                     │
│  │ Nightingale │                     │
│  │   Center    │                     │
│  └─────────────┘                     │
└──────────────────────────────────────┘
           │
           │ 网络链路
           │
┌──────────┴───────────────────────────┐
│         边缘机房                      │
│  ┌─────────────┐                     │
│  │ Nightingale │                     │
│  │    Edge     │ (本地告警引擎)       │
│  └─────────────┘                     │
│         │                            │
│         └─► 本地Prometheus           │
└──────────────────────────────────────┘
```

## 6. 版本信息

- **当前版本**: v8.5.0 (前端)
- **Go版本要求**: 1.24.0
- **Node版本**: 建议使用 LTS 版本
- **许可证**: Apache License 2.0

## 7. 构建和部署

### 7.1 后端构建

```bash
# 下载前端资源并嵌入
sh fe.sh

# 构建中心服务
make build

# 构建其他组件
make build-alert    # 告警引擎
make build-edge     # 边缘引擎
make build-pushgw   # 推送网关
make build-cli      # 命令行工具
```

### 7.2 前端构建

```bash
# 开发模式
npm run dev

# 生产构建
npm run build

# 高级模式构建
npm run build:advanced
```

## 8. 关键特性

1. **多数据源支持**: Prometheus、Elasticsearch、Loki、ClickHouse、MySQL等
2. **灵活的告警规则**: 支持PromQL、日志查询、主机监控等多种规则类型
3. **丰富的通知渠道**: 支持20+种通知媒介(邮件、短信、钉钉、飞书、企微等)
4. **告警降噪**: 支持告警屏蔽、告警聚合、告警抑制
5. **业务组隔离**: 支持多租户,按业务组划分权限
6. **告警自愈**: 支持告警触发后自动执行脚本
7. **事件管道**: 支持对告警事件做Pipeline处理
8. **仪表盘**: 内置仪表盘功能,支持常见图表类型
9. **集成中心**: 内置常用中间件、数据库的监控模板
10. **SSO支持**: 支持OAuth、CAS、LDAP、钉钉等多种认证方式

## 9. 数据库设计

核心数据表包括:
- `alert_rule`: 告警规则
- `alert_cur_event`: 当前告警事件
- `alert_his_event`: 历史告警事件
- `alert_mute`: 告警屏蔽
- `alert_subscribe`: 告警订阅
- `target`: 监控对象
- `busi_group`: 业务组
- `user`: 用户
- `user_group`: 用户组
- `dashboard`: 仪表盘
- `datasource`: 数据源
- `notify_rule`: 通知规则
- `notify_channel`: 通知渠道
- `message_template`: 消息模板
- `event_pipeline`: 事件管道

## 10. API设计

### 10.1 API前缀

- 页面API: `/api/n9e`
- 服务API: `/v1/n9e` (需要BasicAuth)
- Agent API: `/v1/n9e/heartbeat`

### 10.2 认证方式

1. **JWT Token**: 用于Web界面
2. **Basic Auth**: 用于服务间调用
3. **API Token**: 用于第三方集成

### 10.3 核心API分类

- 用户管理: `/api/n9e/users`, `/api/n9e/user-groups`
- 业务组: `/api/n9e/busi-groups`
- 告警规则: `/api/n9e/busi-group/:id/alert-rules`
- 告警事件: `/api/n9e/alert-cur-events`, `/api/n9e/alert-his-events`
- 数据源: `/api/n9e/datasource`
- 仪表盘: `/api/n9e/dashboards`
- 数据查询: `/api/n9e/query-range-batch`, `/api/n9e/ds-query`

## 11. 配置管理

### 11.1 配置文件

- `etc/server.conf`: 主配置文件(TOML格式)
- `etc/metrics.yaml`: 指标元数据配置
- `etc/ops.yaml`: 操作权限配置

### 11.2 配置加载

支持通过环境变量 `N9E_CONFIGS` 指定配置目录,默认为 `etc`

### 11.3 配置加密

支持通过 `--crypto-key` 参数对敏感配置字段进行加密

## 12. 扩展性

### 12.1 插件系统

前端支持插件机制,可以动态加载外部功能模块

### 12.2 数据源扩展

后端通过接口抽象,可以方便地添加新的数据源类型

### 12.3 通知渠道扩展

支持通过Webhook方式集成自定义通知渠道

## 13. 监控和运维

### 13.1 健康检查

- 服务端提供心跳接口
- 支持多个告警引擎实例的负载均衡

### 13.2 性能优化

- 内存缓存(memsto)减少数据库查询
- Redis缓存提升性能
- 告警规则评估支持并发

### 13.3 高可用

- 支持多实例部署
- 数据库主从复制
- Redis哨兵/集群模式
