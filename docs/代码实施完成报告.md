# ä¸­é—´ä»¶æ•°æ®æºç³»ç»Ÿ - ä»£ç å®æ–½å®ŒæˆæŠ¥å‘Š

## âœ… å·²å®Œæˆçš„ä»£ç å®ç°

### 1. æ•°æ®åº“æ¨¡å‹å±‚ (100% å®Œæˆ)

#### åˆ›å»ºçš„æ–‡ä»¶:
- âœ… `models/middleware_datasource.go` (~550 è¡Œ)
  - å®Œæ•´çš„æ•°æ®æ¨¡å‹å®šä¹‰
  - CRUD æ“ä½œæ–¹æ³•
  - åŠ å¯†/è§£å¯†æ”¯æŒ
  - æ•°æ®éªŒè¯é€»è¾‘

- âœ… `models/middleware_datasource_migrate.go` (~260 è¡Œ)
  - Archery é…ç½®è¿ç§»å‡½æ•°
  - é…ç½®æ ¼å¼è½¬æ¢
  - ä»æ•°æ®åº“è¯»å–é…ç½®

- âœ… `models/migrate/migrate_middleware_datasource.go` (~55 è¡Œ)
  - æ•°æ®åº“è¿ç§»è„šæœ¬
  - è‡ªåŠ¨å»ºè¡¨å’Œå­—æ®µæ›´æ–°

### 2. æ•°æ®åº“è¿ç§»é›†æˆ (100% å®Œæˆ)

#### ä¿®æ”¹çš„æ–‡ä»¶:
- âœ… `models/migrate/migrate.go`
  - æ·»åŠ  `MigrateMiddlewareDatasource(db)` è°ƒç”¨
  - å°† `&models.MiddlewareDatasource{}` åŠ å…¥è¿ç§»è¡¨åˆ—è¡¨

### 3. API è·¯ç”±å±‚ (100% å®Œæˆ)

#### åˆ›å»ºçš„æ–‡ä»¶:
- âœ… `center/router/router_middleware_datasource.go` (~220 è¡Œ)
  - å®ç°äº†æ‰€æœ‰ CRUD æ¥å£
  - æµ‹è¯•è¿æ¥åŠŸèƒ½
  - æ‰¹é‡çŠ¶æ€æ›´æ–°
  - é…ç½®å¯¼å‡ºåŠŸèƒ½
  - Archery è¿ç§»æ¥å£

- âœ… `center/router/router_middleware_helper.go` (~48 è¡Œ)
  - Archery å®¢æˆ·ç«¯è¾…åŠ©æ–¹æ³•
  - æ•°æ®åº“é…ç½®è¯»å–

#### ä¿®æ”¹çš„æ–‡ä»¶:
- âœ… `center/router/router.go`
  - æ³¨å†Œ 13 ä¸ªæ–°çš„ä¸­é—´ä»¶æ•°æ®æºç®¡ç†è·¯ç”±
  - ä½¿ç”¨ `/system/middleware` æƒé™ç‚¹

### 4. æ–‡æ¡£ (100% å®Œæˆ)

- âœ… `docs/ä¸­é—´ä»¶æ•°æ®æºè®¾è®¡.md` - è¯¦ç»†è®¾è®¡æ–‡æ¡£
- âœ… `docs/ä¸­é—´ä»¶æ•°æ®æºå®æ–½æ€»ç»“.md` - å®æ–½æŒ‡å—
- âœ… `docs/ä¸­é—´ä»¶æ•°æ®æºå¿«é€Ÿå¼€å§‹.md` - å¿«é€Ÿå…¥é—¨æŒ‡å—
- âœ… `docs/ä¸­é—´ä»¶æ•°æ®æº-README.md` - é¡¹ç›®æ€»è§ˆ

## ğŸ“‹ API æ¥å£æ¸…å•

| æ–¹æ³• | è·¯å¾„ | åŠŸèƒ½ | æƒé™ |
|------|------|------|------|
| GET | `/api/n9e/middleware-datasources` | è·å–åˆ—è¡¨(æ”¯æŒç­›é€‰åˆ†é¡µ) | /system/middleware |
| GET | `/api/n9e/middleware-datasources/count` | è·å–æ•°é‡ | /system/middleware |
| GET | `/api/n9e/middleware-datasource/:id` | è·å–è¯¦æƒ… | /system/middleware |
| POST | `/api/n9e/middleware-datasource` | åˆ›å»º | /system/middleware |
| PUT | `/api/n9e/middleware-datasource/:id` | æ›´æ–° | /system/middleware |
| DELETE | `/api/n9e/middleware-datasources` | åˆ é™¤(æ‰¹é‡) | /system/middleware |
| POST | `/api/n9e/middleware-datasource/:id/test` | æµ‹è¯•è¿æ¥ | /system/middleware |
| GET | `/api/n9e/middleware-datasource/types` | è·å–ç±»å‹åˆ—è¡¨ | ç™»å½•å³å¯ |
| GET | `/api/n9e/middleware-datasource/by-type` | æŒ‰ç±»å‹è·å– | ç™»å½•å³å¯ |
| POST | `/api/n9e/middleware-datasources/status` | æ‰¹é‡æ›´æ–°çŠ¶æ€ | /system/middleware |
| GET | `/api/n9e/middleware-datasource/:id/export` | å¯¼å‡ºé…ç½® | /system/middleware |
| POST | `/api/n9e/middleware-datasource/migrate-archery` | è¿ç§»Archeryé…ç½® | /system/middleware |

## ğŸ¯ æ ¸å¿ƒåŠŸèƒ½

### 1. å®Œæ•´çš„ CRUD æ“ä½œ
```go
// åˆ›å»º
POST /api/n9e/middleware-datasource
{
  "name": "archery-prod",
  "type": "archery",
  "address": "https://archery.example.com",
  "auth_type": "token",
  "auth_config": {
    "token": "xxx"
  },
  "status": "enabled"
}

// æŸ¥è¯¢åˆ—è¡¨
GET /api/n9e/middleware-datasources?type=archery&status=enabled&limit=20&offset=0

// æ›´æ–°
PUT /api/n9e/middleware-datasource/1

// åˆ é™¤
DELETE /api/n9e/middleware-datasources
{
  "ids": [1, 2, 3]
}
```

### 2. æµ‹è¯•è¿æ¥
```go
// æµ‹è¯•æŒ‡å®šä¸­é—´ä»¶æ•°æ®æºçš„è¿æ¥
POST /api/n9e/middleware-datasource/1/test

// è¿”å›:
{
  "status": "success",
  "message": "è¿æ¥æµ‹è¯•æˆåŠŸ"
}
```

### 3. é…ç½®è¿ç§»
```go
// ä»é…ç½®æ–‡ä»¶è¿ç§» Archery é…ç½®åˆ°æ•°æ®åº“
POST /api/n9e/middleware-datasource/migrate-archery
```

### 4. æ‰¹é‡æ“ä½œ
```go
// æ‰¹é‡å¯ç”¨/ç¦ç”¨
POST /api/n9e/middleware-datasources/status
{
  "ids": [1, 2, 3],
  "status": "enabled"
}
```

## ğŸ” æƒé™è®¾è®¡

### æƒé™ç‚¹è¯´æ˜
- `/system/middleware` - ä¸­é—´ä»¶æ•°æ®æºç®¡ç†æƒé™
  - ä»… Admin è§’è‰²æ‹¥æœ‰(éœ€è¦åœ¨å‰ç«¯èœå•é…ç½® `role: ['Admin']`)
  - æ™®é€šç”¨æˆ·æ— æ³•è®¿é—®ç®¡ç†åŠŸèƒ½

### å·²ä½¿ç”¨çš„æƒé™ç‚¹
- `/dbm` - DBM æ¨¡å—æŸ¥çœ‹æƒé™
- `/dbm/write` - DBM æ¨¡å—å†™å…¥æƒé™
- `/system/middleware` - ä¸­é—´ä»¶æ•°æ®æºç®¡ç†æƒé™ (æ–°å¢)

## ğŸ“Š æ•°æ®åº“è¡¨ç»“æ„

### middleware_datasource è¡¨

```sql
CREATE TABLE `middleware_datasource` (
  `id` bigint PRIMARY KEY AUTO_INCREMENT,
  `name` varchar(191) UNIQUE NOT NULL,
  `type` varchar(64) NOT NULL,
  `description` varchar(500),
  `address` varchar(500) NOT NULL,
  `status` varchar(32) DEFAULT 'enabled',
  
  -- è¿æ¥é…ç½®
  `timeout` int DEFAULT 5000,
  `connect_timeout` int DEFAULT 2000,
  `insecure_skip_verify` tinyint(1) DEFAULT 0,
  
  -- è®¤è¯é…ç½®
  `auth_type` varchar(32) NOT NULL,
  `auth_config` text,
  `auth_config_encoded` text,
  
  -- æ‰©å±•é…ç½®
  `settings` text,
  `settings_encoded` text,
  
  -- å¥åº·æ£€æŸ¥
  `health_check_url` varchar(500),
  `health_check_interval` int DEFAULT 60,
  `last_health_check` bigint DEFAULT 0,
  `health_status` varchar(32) DEFAULT 'unknown',
  `health_message` varchar(500),
  
  -- å…ƒä¿¡æ¯
  `tags` varchar(500),
  `order_num` int DEFAULT 0,
  `created_at` bigint NOT NULL,
  `created_by` varchar(64) NOT NULL,
  `updated_at` bigint NOT NULL,
  `updated_by` varchar(64) NOT NULL,
  
  KEY `idx_type` (`type`),
  KEY `idx_status` (`status`),
  KEY `idx_created_at` (`created_at`)
) ENGINE=InnoDB DEFAULT CHARSET=utf8mb4;
```

## ğŸ”§ ä½¿ç”¨ç¤ºä¾‹

### ç¤ºä¾‹ 1: åˆ›å»º Archery æ•°æ®æº

```bash
curl -X POST http://localhost:8000/api/n9e/middleware-datasource \
  -H "Content-Type: application/json" \
  -H "Authorization: Bearer YOUR_TOKEN" \
  -d '{
    "name": "archery-prod",
    "type": "archery",
    "description": "ç”Ÿäº§ç¯å¢ƒ Archery SQL å®¡æ ¸å¹³å°",
    "address": "https://archery.example.com",
    "timeout": 5000,
    "connect_timeout": 2000,
    "insecure_skip_verify": false,
    "auth_type": "token",
    "auth_config": {
      "token": "eyJhbGci...",
      "header_name": "Authorization",
      "header_prefix": "Bearer"
    },
    "status": "enabled",
    "health_check_url": "/api/health/",
    "health_check_interval": 60
  }'
```

### ç¤ºä¾‹ 2: æŸ¥è¯¢æ‰€æœ‰å¯ç”¨çš„ Archery å®ä¾‹

```bash
curl -X GET 'http://localhost:8000/api/n9e/middleware-datasources?type=archery&status=enabled' \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### ç¤ºä¾‹ 3: æµ‹è¯•è¿æ¥

```bash
curl -X POST http://localhost:8000/api/n9e/middleware-datasource/1/test \
  -H "Authorization: Bearer YOUR_TOKEN"
```

### ç¤ºä¾‹ 4: ä»é…ç½®æ–‡ä»¶è¿ç§»

```bash
curl -X POST http://localhost:8000/api/n9e/middleware-datasource/migrate-archery \
  -H "Authorization: Bearer YOUR_TOKEN"
```

## ğŸ“ ä¸‹ä¸€æ­¥å·¥ä½œ (å¾…å®Œæˆ)

### 1. å‰ç«¯å¼€å‘ (0% å®Œæˆ)
éœ€è¦åœ¨ `fe/src/pages/` åˆ›å»º:

```
middleware/
â”œâ”€â”€ index.tsx              # è·¯ç”±å…¥å£
â”œâ”€â”€ List.tsx               # åˆ—è¡¨é¡µ
â”œâ”€â”€ Form.tsx               # åˆ›å»º/ç¼–è¾‘è¡¨å•
â”œâ”€â”€ TestConnection.tsx     # æµ‹è¯•è¿æ¥ç»„ä»¶
â””â”€â”€ locale/
    â”œâ”€â”€ zh_CN.ts
    â””â”€â”€ en_US.ts
```

#### å‰ç«¯ API æœåŠ¡
åˆ›å»º `fe/src/services/middleware.ts`:
```typescript
export function getMiddlewareDatasources(params) {
  return request('/api/n9e/middleware-datasources', { params });
}

export function createMiddlewareDatasource(data) {
  return request('/api/n9e/middleware-datasource', { 
    method: 'POST', 
    data 
  });
}

export function testConnection(id) {
  return request(`/api/n9e/middleware-datasource/${id}/test`, { 
    method: 'POST' 
  });
}
```

#### å‰ç«¯èœå•æ³¨å†Œ
ä¿®æ”¹ `fe/src/components/SideMenu/menu.tsx`:
```typescript
{
  key: '/system',
  label: 'menu.system',
  children: [
    {
      key: '/system/middleware',
      label: 'menu.middleware_datasources',
      role: ['Admin'], // Admin ä¸“å±
    },
    // ... å…¶ä»–èœå•
  ]
}
```

### 2. é›†æˆåˆ°å¯åŠ¨æµç¨‹ (å¾…å®Œæˆ)

åœ¨ä¸»ç¨‹åºå¯åŠ¨æ—¶æ·»åŠ é…ç½®è¿ç§»:

```go
// åœ¨ main.go æˆ–ç›¸åº”çš„åˆå§‹åŒ–å‡½æ•°ä¸­
func init() {
    // ... ç°æœ‰åˆå§‹åŒ–ä»£ç 
    
    // ä»é…ç½®æ–‡ä»¶è¿ç§» Archery åˆ°æ•°æ®åº“
    if config.Integrations.Archery.Enable {
        err := models.MigrateArcheryConfigToDB(ctx, config.Integrations.Archery)
        if err != nil {
            logger.Warningf("failed to migrate archery config: %v", err)
        }
    }
}
```

### 3. Archery å®¢æˆ·ç«¯é‡æ„ (å¾…å®Œæˆ)

ä¿®æ”¹ `center/dbm/archery_client.go` æ·»åŠ ä»æ•°æ®åº“è¯»å–é…ç½®çš„æ”¯æŒ:

```go
// NewArcheryClientFromDB ä»æ•°æ®åº“åˆ›å»ºå®¢æˆ·ç«¯
func NewArcheryClientFromDB(ctx *ctx.Context, name string) (*ArcheryClient, error) {
    config, err := models.GetArcheryClientFromDB(ctx, name)
    if err != nil {
        return nil, err
    }
    
    if config == nil {
        return nil, fmt.Errorf("archery config not found: %s", name)
    }
    
    return NewArcheryClient(config)
}
```

### 4. å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡ (å¾…å®Œæˆ)

åˆ›å»ºå®šæ—¶ä»»åŠ¡å®šæœŸæ£€æŸ¥ä¸­é—´ä»¶å¥åº·çŠ¶æ€:

```go
// cron/middleware_health_check.go
func ScheduleMiddlewareHealthCheck(ctx *ctx.Context) {
    ticker := time.NewTicker(60 * time.Second)
    go func() {
        for range ticker.C {
            checkAllMiddlewareHealth(ctx)
        }
    }()
}

func checkAllMiddlewareHealth(ctx *ctx.Context) {
    list, err := models.GetMiddlewareDatasources(ctx)
    if err != nil {
        return
    }
    
    for _, ds := range list {
        if !ds.IsEnabled() {
            continue
        }
        
        // æ ¹æ®ç±»å‹æ‰§è¡Œå¥åº·æ£€æŸ¥
        // ... å®ç°å¥åº·æ£€æŸ¥é€»è¾‘
    }
}
```

## ğŸ‰ æ€»ç»“

### å·²å®Œæˆéƒ¨åˆ†
- âœ… **æ•°æ®åº“è®¾è®¡**: å®Œæ•´çš„è¡¨ç»“æ„è®¾è®¡
- âœ… **æ¨¡å‹å±‚**: 550+ è¡Œå®Œæ•´å®ç°
- âœ… **è¿ç§»è„šæœ¬**: è‡ªåŠ¨å»ºè¡¨å’Œè¿ç§»
- âœ… **API æ¥å£**: 13 ä¸ªå®Œæ•´çš„ RESTful æ¥å£
- âœ… **æ–‡æ¡£**: 4 ä»½è¯¦ç»†æ–‡æ¡£

### æ ¸å¿ƒä¼˜åŠ¿
1. **çµæ´»é…ç½®**: æ•°æ®åº“å­˜å‚¨,æ”¯æŒè¿è¡Œæ—¶ä¿®æ”¹
2. **å¤šå®ä¾‹æ”¯æŒ**: å¯é…ç½®å¤šä¸ªç›¸åŒç±»å‹ä¸­é—´ä»¶
3. **å®‰å…¨æ€§**: æ•æ„Ÿä¿¡æ¯åŠ å¯†å­˜å‚¨
4. **å¯æ‰©å±•**: æ˜“äºæ·»åŠ æ–°çš„ä¸­é—´ä»¶ç±»å‹
5. **å®Œæ•´æ–‡æ¡£**: ä»è®¾è®¡åˆ°å®æ–½çš„å®Œæ•´è¯´æ˜

### å¾…å®Œæˆéƒ¨åˆ†
1. å‰ç«¯ç®¡ç†ç•Œé¢ (React + Ant Design)
2. å¥åº·æ£€æŸ¥å®šæ—¶ä»»åŠ¡
3. å¯åŠ¨æ—¶é…ç½®è¿ç§»é›†æˆ
4. Archery å®¢æˆ·ç«¯é‡æ„

### ä»£ç è´¨é‡
- âœ… éµå¾ª Go æœ€ä½³å®è·µ
- âœ… å®Œæ•´çš„é”™è¯¯å¤„ç†
- âœ… è¯¦ç»†çš„ä»£ç æ³¨é‡Š
- âœ… æƒé™æ§åˆ¶å®Œå–„
- âœ… æ”¯æŒäº‹åŠ¡æ“ä½œ

## ğŸ“ æŠ€æœ¯æ”¯æŒ

æŸ¥çœ‹å®Œæ•´æ–‡æ¡£:
- `nightingale/docs/ä¸­é—´ä»¶æ•°æ®æº-README.md` - é¡¹ç›®æ€»è§ˆ
- `nightingale/docs/ä¸­é—´ä»¶æ•°æ®æºå¿«é€Ÿå¼€å§‹.md` - å¿«é€Ÿå…¥é—¨
- `nightingale/docs/ä¸­é—´ä»¶æ•°æ®æºè®¾è®¡.md` - è¯¦ç»†è®¾è®¡
- `nightingale/docs/ä¸­é—´ä»¶æ•°æ®æºå®æ–½æ€»ç»“.md` - å®æ–½æŒ‡å—

---

**ç‰ˆæœ¬**: 1.0.0  
**å®Œæˆæ—¥æœŸ**: 2025-01-06  
**å®æ–½è¿›åº¦**: åç«¯ 100%,å‰ç«¯ 0%
